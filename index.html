<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KITT FRANCO-BELGE // SYSTÈME CENTRAL</title>
<meta name="description" content="Interface KITT Franco-Belge — IA embarquée sur NVIDIA Jetson. Projet fan non commercial par Manix."/>
<meta name="theme-color" content="#000000"/>
<!-- ★ AMÉLIORATION : Polices distinctives -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<style>
:root{
  --green:#00ff66;
  --green-dim:#00aa44;
  --red:#ff1a1a;
  --amber:#ffaa00;
  --cyan:#00ccff;
  --border-dim:rgba(0,255,102,.15);
  /* ★ Nouvelles polices */
  --font-display:"Orbitron","Courier New",monospace;
  --font-terminal:"VT323","Courier New",monospace;
  --font-mono:"Share Tech Mono","Courier New",monospace;
  --bg:#000;
}
*{box-sizing:border-box;}
html,body{margin:0;height:100%;background:var(--bg);color:var(--green);font-family:var(--font-mono);overflow:hidden;}

/* CRT scanlines */
body::before{content:"";position:fixed;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18) 1px,transparent 1px,transparent 3px);pointer-events:none;z-index:9998;}
body::after{content:"";position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,255,80,.015);pointer-events:none;z-index:9999;animation:flicker .12s infinite;}
@keyframes flicker{0%{opacity:.88}48%{opacity:1}52%{opacity:.92}100%{opacity:.96}}

/* ── ÉCRAN ACCÈS ──────────────────────────────────────────── */
@keyframes accessPulse{0%,100%{text-shadow:0 0 8px #FF9900}50%{text-shadow:0 0 22px #FF9900,0 0 50px rgba(255,153,0,.4)}}
@keyframes inputBlink{0%,49%{border-color:#884400}50%,100%{border-color:#FF9900}}
@keyframes wrongShake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
#access-screen{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.93);z-index:9500;
  display:flex;align-items:center;justify-content:center;
  padding:20px;
}
#access-box{
  width:100%;max-width:480px;
  border:1px solid #CC6600;border-radius:8px;
  background:rgba(4,2,0,.6);backdrop-filter:blur(8px);
  padding:32px 36px;position:relative;overflow:hidden;
  box-shadow:0 0 80px rgba(255,100,0,.1),inset 0 0 40px rgba(255,80,0,.03);
}
#access-box::after{content:'';position:absolute;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,153,0,.35),transparent);animation:scanBar 3s linear infinite;pointer-events:none;}
#access-hdr{
  color:#FF9900;letter-spacing:4px;font-size:12px;text-align:center;
  border-bottom:1px solid #663300;padding-bottom:12px;margin-bottom:20px;
  animation:accessPulse 3s ease-in-out infinite;
  font-family:var(--font-display);
}
#access-log{min-height:100px;font-size:11px;letter-spacing:2px;line-height:2;margin-bottom:16px;color:#885500;font-family:var(--font-mono);}
#access-log .a-line{color:#FF8800;}
#access-log .a-ok{color:#FFAA00;}
#access-log .a-err{color:#ff3300;}
#access-input-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
#access-prompt{color:#FF6600;font-size:12px;letter-spacing:2px;white-space:nowrap;font-family:var(--font-mono);}
#access-input{
  flex:1;background:transparent;border:none;border-bottom:1px solid #884400;
  color:#FF9900;font-family:var(--font-terminal);font-size:20px;
  letter-spacing:4px;outline:none;padding:4px 0;caret-color:#FF9900;
  animation:inputBlink 1.1s step-end infinite;
}
#access-input::placeholder{color:#442200;letter-spacing:2px;font-size:11px;}
#access-hint{font-size:9px;color:#442200;letter-spacing:2px;text-align:center;font-family:var(--font-mono);}
/* ★ Barre de progression accès */
#access-progress{height:2px;background:rgba(255,153,0,.1);margin-top:16px;border-radius:1px;overflow:hidden;}
#access-progress-bar{height:100%;width:0;background:linear-gradient(90deg,#FF6600,#FF9900);transition:width .3s ease;border-radius:1px;}
#access-box.wrong{animation:wrongShake .4s ease;}

/* ── MU-TH-UR 6000 INTRO ──────────────────────────────────── */
#mother-intro{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.92);z-index:9000;
  display:flex;align-items:center;justify-content:center;
  padding:20px;
}
#mother-box{
  width:100%;max-width:560px;
  border:1px solid #CC6600;
  box-shadow:0 0 60px rgba(255,140,0,.12),inset 0 0 40px rgba(255,100,0,.03);
  padding:28px 36px;
}
#mother-hdr{
  color:#FF9900;letter-spacing:4px;font-size:13px;
  text-align:center;border-bottom:1px solid #884400;
  padding-bottom:12px;margin-bottom:16px;
  text-shadow:0 0 14px #FF990060;
  font-family:var(--font-display);
}
#mother-output{
  min-height:260px;font-size:13px;
  letter-spacing:1px;line-height:1.9;
  font-family:var(--font-mono);
}
.m-bright{color:#FFAA00;text-shadow:0 0 10px #FF990050;}
.m-normal{color:#FF8800;}
.m-dim{color:#885500;}
.m-ok{color:#FFAA00;}
#mother-skip{
  margin-top:18px;font-size:10px;color:#663300;
  letter-spacing:3px;text-align:center;display:none;
  animation:mskip 1.1s step-end infinite;
  font-family:var(--font-mono);
}
@keyframes mskip{0%,49%{opacity:1}50%,100%{opacity:0}}

/* ── LANGUAGE SELECTION ───────────────────────────────────── */
@keyframes ks{0%{left:-200px}100%{left:100%}}
@keyframes pred{0%,100%{text-shadow:0 0 12px var(--red)}50%{text-shadow:0 0 28px var(--red),0 0 50px rgba(255,26,26,.5)}}
@keyframes bd{0%,100%{opacity:1}50%{opacity:.25}}
#lang-screen{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:radial-gradient(ellipse 600px 700px at center,rgba(0,4,1,.82) 0%,rgba(0,0,0,.5) 70%,rgba(0,0,0,.2) 100%);
  z-index:8000;
  display:flex;align-items:center;justify-content:center;
  padding:16px;
}
#lang-screen::before{
  content:'';position:absolute;inset:0;
  background-image:linear-gradient(rgba(0,255,102,.018) 1px, transparent 1px),linear-gradient(90deg, rgba(0,255,102,.018) 1px, transparent 1px);
  background-size:32px 32px;pointer-events:none;
}
#lang-screen .lang-scanner-top{position:absolute;top:0;left:0;right:0;height:2px;overflow:hidden;}
#lang-screen .lang-scanner-top::after{content:'';position:absolute;top:0;width:160px;height:2px;background:linear-gradient(90deg,transparent,var(--red),transparent);box-shadow:0 0 10px 3px var(--red);animation:ks 2.2s ease-in-out infinite alternate;}
#lang-screen .lang-scanner-bot{position:absolute;bottom:0;left:0;right:0;height:2px;overflow:hidden;}
#lang-screen .lang-scanner-bot::after{content:'';position:absolute;top:0;width:160px;height:2px;background:linear-gradient(90deg,transparent,var(--red),transparent);box-shadow:0 0 10px 3px var(--red);animation:ks 2.2s ease-in-out infinite alternate-reverse;}
#lang-box{
  width:100%;max-width:520px;
  border:1px solid rgba(0,255,102,.35);border-radius:10px;
  box-shadow:0 0 80px rgba(0,255,102,.12),0 0 160px rgba(0,255,102,.05),inset 0 0 60px rgba(0,255,102,.02),0 0 4px rgba(255,26,26,.3);
  background:rgba(0,8,3,.52);backdrop-filter:blur(6px);
  font-size:13px;animation:boxIn .5s ease-out;position:relative;overflow:hidden;
}
#lang-box::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,transparent 5%,var(--red) 30%,rgba(255,26,26,.5) 70%,transparent 95%);border-radius:10px 0 0 10px;}
@keyframes boxIn{from{opacity:0;transform:scale(.94) translateY(12px)}to{opacity:1;transform:none}}
#lang-hdr{border-bottom:1px solid var(--border-dim);padding:16px 24px 14px;text-align:center;background:linear-gradient(180deg,rgba(255,26,26,.04),rgba(0,255,102,.02));position:relative;}
#lang-logo-line{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:6px;}
.lang-logo-kitt{color:var(--red);font-family:var(--font-display);font-size:19px;font-weight:900;letter-spacing:6px;text-shadow:0 0 20px var(--red),0 0 50px rgba(255,26,26,.3);animation:pred 3s ease-in-out infinite;}
.lang-logo-sep{color:var(--green-dim);font-size:15px;letter-spacing:1px;text-shadow:0 0 8px var(--green-dim);}
.lang-logo-alien{color:var(--amber);font-family:var(--font-display);font-size:19px;font-weight:900;letter-spacing:5px;text-shadow:0 0 20px var(--amber),0 0 50px rgba(255,170,0,.3);animation:amberPulse 4s ease-in-out infinite;}
@keyframes amberPulse{0%,100%{text-shadow:0 0 12px var(--amber),0 0 30px rgba(255,170,0,.2)}50%{text-shadow:0 0 28px var(--amber),0 0 70px rgba(255,170,0,.5)}}
#lang-sys-id{color:var(--green);font-family:var(--font-mono);font-size:10px;letter-spacing:3px;text-shadow:0 0 10px var(--green);}
#lang-sub{padding:10px 24px 8px;color:var(--amber);letter-spacing:3px;font-size:9px;border-bottom:1px solid rgba(255,170,0,.12);text-shadow:0 0 8px rgba(122,79,0,1);display:flex;align-items:center;gap:8px;font-family:var(--font-mono);}
#lang-sub::before{content:'▶';color:var(--red);font-size:8px;animation:bd 1.2s ease-in-out infinite;}
#lang-output{padding:4px 0 2px;}
.lang-opt{display:flex;align-items:center;gap:14px;padding:9px 24px;cursor:pointer;transition:background .12s,border-left-color .12s,transform .1s;border-left:2px solid transparent;border-bottom:1px solid rgba(0,255,102,.05);position:relative;border-radius:4px;margin:1px 8px;}
.lang-opt:last-child{border-bottom:none;}
.lang-opt:hover{background:linear-gradient(90deg,rgba(255,26,26,.1),rgba(0,255,102,.07),rgba(0,0,0,.1));border-left-color:var(--red);transform:translateX(4px);box-shadow:inset 0 0 24px rgba(0,255,102,.05),-3px 0 12px rgba(255,26,26,.25);}
.lang-opt:hover .lo-n{border-color:var(--red);color:var(--red);box-shadow:0 0 8px rgba(255,26,26,.3);transform:scale(1.1);}
.lang-opt:hover .lo-flag{filter:saturate(1.5) brightness(1.2);}
.lang-opt:hover .lo-label{text-shadow:0 0 12px var(--green);color:var(--green);}
.lang-opt:hover .lo-native{color:var(--amber);}
.lang-opt::after{content:'';position:absolute;left:0;top:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(0,255,102,.06),transparent);transform:translateX(-100%);transition:transform .35s ease;pointer-events:none;border-radius:4px;}
.lang-opt:hover::after{transform:translateX(100%);}
.lo-n{color:var(--green-dim);font-size:11px;min-width:24px;text-align:center;border:1px solid rgba(0,255,102,.5);padding:2px 4px;letter-spacing:1px;flex-shrink:0;transition:all .15s;font-family:var(--font-display);}
.lo-flag{font-size:22px;flex-shrink:0;transition:filter .12s;line-height:1;filter:drop-shadow(0 0 3px rgba(255,255,255,.3));}
.lo-text{flex:1;display:flex;flex-direction:column;gap:2px;}
.lo-label{color:var(--green);letter-spacing:2px;font-size:12px;transition:all .12s;font-family:var(--font-display);font-weight:700;}
.lo-native{color:var(--green-dim);font-size:10px;letter-spacing:1px;opacity:.7;transition:color .12s;font-family:var(--font-mono);}
.lo-voice-btn{flex-shrink:0;background:rgba(255,170,0,.05);border:1px solid rgba(255,170,0,.25);color:rgba(122,79,0,1);font-size:10px;padding:3px 8px;cursor:pointer;font-family:var(--font-mono);letter-spacing:1px;transition:all .12s;display:flex;align-items:center;gap:4px;}
.lo-voice-btn:hover{background:rgba(255,170,0,.12);border-color:var(--amber);color:var(--amber);box-shadow:0 0 8px rgba(255,170,0,.2);}
.lo-voice-btn::before{content:'▶';font-size:8px;}
#lang-ftr{border-top:1px solid var(--border-dim);padding:10px 24px;color:var(--green-dim);font-size:10px;letter-spacing:2px;display:flex;align-items:center;justify-content:space-between;background:rgba(0,255,102,.015);border-radius:0 0 10px 10px;font-family:var(--font-mono);}
#lang-ftr-left{display:flex;align-items:center;gap:6px;}
#lang-ftr-right{color:rgba(255,26,26,.5);font-size:9px;letter-spacing:1px;animation:bd 2s ease-in-out infinite;}
#lang-voice-toggle{margin-left:8px;background:rgba(0,255,102,.04);border:1px solid rgba(0,255,102,.25);color:var(--green-dim);font-size:9px;padding:2px 7px;cursor:pointer;font-family:var(--font-mono);letter-spacing:1px;transition:all .12s;}
#lang-voice-toggle:hover{color:var(--green);border-color:var(--green);background:rgba(0,255,102,.08);}
#lang-flag{font-size:10px;border:1px solid var(--green-dim);padding:1px 5px;letter-spacing:1px;cursor:pointer;color:var(--green-dim);font-family:var(--font-mono);}
#lang-flag:hover{color:var(--green);border-color:var(--green);}
#lang-data-line{padding:5px 24px;font-size:9px;letter-spacing:3px;color:rgba(0,255,102,.35);border-top:1px solid rgba(0,255,102,.1);display:flex;justify-content:space-between;font-family:var(--font-mono);background:rgba(0,255,102,.015);}
@keyframes langBoxPulse{0%,100%{box-shadow:0 0 80px rgba(0,255,102,.12),inset 0 0 60px rgba(0,255,102,.02),0 0 4px rgba(255,26,26,.3)}50%{box-shadow:0 0 140px rgba(0,255,102,.2),0 0 60px rgba(0,255,102,.08),inset 0 0 80px rgba(0,255,102,.05),0 0 12px rgba(255,26,26,.5),0 0 40px rgba(255,26,26,.15)}}
@keyframes scanBar{0%{top:-2px}100%{top:101%}}
@keyframes cornerBlink{0%,100%{opacity:.5}50%{opacity:1}}
@keyframes ringPulse{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:.2}50%{transform:translate(-50%,-50%) scale(1.06);opacity:.45}}
#lang-screen::after{content:'';position:absolute;left:50%;top:50%;width:min(580px,96vw);height:min(780px,94vh);border:1px solid rgba(0,255,102,.1);border-radius:14px;animation:ringPulse 3.5s ease-in-out infinite;pointer-events:none;}
#lang-box{animation:boxIn .5s ease-out,langBoxPulse 3.5s ease-in-out 1s infinite;}
#lang-box::after{content:'';position:absolute;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 5%,rgba(0,255,102,.4) 50%,transparent 95%);box-shadow:0 0 6px rgba(0,255,102,.3);animation:scanBar 3.8s linear infinite;pointer-events:none;z-index:10;}
#lang-box .hud-tl,#lang-box .hud-tr,#lang-box .hud-bl,#lang-box .hud-br{position:absolute;width:14px;height:14px;animation:cornerBlink 1.8s ease-in-out infinite;}
#lang-box .hud-tl{top:-1px;left:-1px;border-top:2px solid var(--red);border-left:2px solid var(--red);border-radius:10px 0 0 0;}
#lang-box .hud-tr{top:-1px;right:-1px;border-top:2px solid var(--red);border-right:2px solid var(--red);border-radius:0 10px 0 0;}
#lang-box .hud-bl{bottom:-1px;left:-1px;border-bottom:2px solid var(--red);border-left:2px solid var(--red);border-radius:0 0 0 10px;}
#lang-box .hud-br{bottom:-1px;right:-1px;border-bottom:2px solid var(--red);border-right:2px solid var(--red);border-radius:0 0 10px 0;}

/* ── SCANNERS KITT ─────────────────────────────────────────── */
#sw{position:fixed;top:0;left:0;right:0;height:3px;overflow:hidden;z-index:1000;}
#sb{position:absolute;top:0;width:200px;height:3px;background:linear-gradient(90deg,transparent,var(--red),var(--red),transparent);box-shadow:0 0 14px 4px var(--red);animation:ks 1.8s ease-in-out infinite alternate;}
#swb{position:fixed;bottom:0;left:0;right:0;height:3px;overflow:hidden;z-index:1000;}
#sbb{position:absolute;top:0;width:200px;height:3px;background:linear-gradient(90deg,transparent,var(--red),var(--red),transparent);box-shadow:0 0 14px 4px var(--red);animation:ks 1.8s ease-in-out infinite alternate-reverse;}

/* ── STARFIELD ─────────────────────────────────────────────── */
#starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;}

/* ── FOND JARVIS ───────────────────────────────────────────── */
#jarvis-svg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) translate3d(0,0,0);width:min(90vw,90vh);height:min(90vw,90vh);pointer-events:none;z-index:0;opacity:0.45;}
#sphere-wrap{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:180px;height:180px;perspective:500px;pointer-events:none;z-index:0;opacity:0.22;}
#sphere-3d{width:100%;height:100%;transform-style:preserve-3d;animation:srot 22s linear infinite;}
@keyframes srot{from{transform:rotateX(22deg) rotateY(0deg)}to{transform:rotateX(22deg) rotateY(360deg)}}
.s-mer,.s-par{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;border:1px solid var(--green);box-sizing:border-box;opacity:0.7;}
.s-core{position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;border-radius:50%;background:radial-gradient(circle,var(--green),transparent);box-shadow:0 0 20px var(--green),0 0 40px rgba(0,255,102,.4);animation:score 3s ease-in-out infinite;}
@keyframes score{0%,100%{opacity:.6}50%{opacity:1}}

/* ── COMPTEUR VISITES ──────────────────────────────────────── */
#visit-counter{position:fixed;left:8px;top:50%;transform:translateY(-50%);writing-mode:vertical-rl;text-orientation:mixed;font-size:11px;color:var(--green);letter-spacing:3px;opacity:.65;pointer-events:none;z-index:100;text-shadow:0 0 8px var(--green),0 0 16px rgba(0,255,102,.4);user-select:none;border-left:1px solid rgba(0,255,102,.3);padding-left:4px;font-family:var(--font-mono);}

/* ── FOOTER ────────────────────────────────────────────────── */
#site-footer{position:fixed;bottom:84px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--green-dim);letter-spacing:2px;opacity:.55;pointer-events:none;z-index:1001;white-space:nowrap;user-select:none;text-shadow:0 0 6px var(--green-dim);font-family:var(--font-mono);}

/* ── HEADER ★ AMÉLIORÉ ────────────────────────────────────── */
header{
  flex-shrink:0;
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0 6px;
  border-bottom:1px solid rgba(255,26,26,.15);
  margin-bottom:4px;
  position:relative;
}
header::after{
  content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,255,102,.3),transparent);
  animation:scanBar 4s linear infinite;
}
.hdr-title{
  color:var(--red);font-family:var(--font-display);
  font-size:12px;letter-spacing:3px;font-weight:700;
  text-shadow:0 0 16px rgba(255,26,26,.6);
  flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.hdr-right{
  display:flex;align-items:center;gap:10px;
  font-size:11px;color:var(--green-dim);letter-spacing:1px;
  font-family:var(--font-mono);flex-shrink:0;
}
/* ★ Indicateurs header */
.hdr-indicator{display:flex;align-items:center;gap:4px;font-size:9px;letter-spacing:1px;}
.hdr-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.hdr-dot.green{background:var(--green);box-shadow:0 0 6px var(--green);animation:dotPulse 2s ease-in-out infinite;}
.hdr-dot.red{background:var(--red);box-shadow:0 0 6px var(--red);animation:dotPulse 1.5s ease-in-out infinite;}
.hdr-dot.amber{background:var(--amber);box-shadow:0 0 6px var(--amber);}
@keyframes dotPulse{0%,100%{opacity:1}50%{opacity:.3}}
#clock{font-family:var(--font-display);font-size:11px;color:var(--cyan);letter-spacing:2px;text-shadow:0 0 8px var(--cyan);}
/* ★ Mode KITT indicator */
#kitt-mode-badge{
  font-family:var(--font-display);font-size:8px;letter-spacing:2px;
  padding:2px 6px;border:1px solid;border-radius:2px;
  transition:all .3s;
}
#kitt-mode-badge.normal{color:var(--green);border-color:var(--green);box-shadow:0 0 6px rgba(0,255,102,.2);}
#kitt-mode-badge.pursuit{color:var(--cyan);border-color:var(--cyan);box-shadow:0 0 6px rgba(0,204,255,.4);animation:modeFlash .6s ease-in-out infinite;}
#kitt-mode-badge.turbo{color:var(--red);border-color:var(--red);box-shadow:0 0 12px rgba(255,26,26,.6);animation:modeFlash .3s ease-in-out infinite;}
@keyframes modeFlash{0%,100%{opacity:1}50%{opacity:.4}}

/* ── TERMINAL ─────────────────────────────────────────────── */
#terminal{flex:1;overflow-y:auto;overflow-x:hidden;padding:8px 4px;font-size:15px;line-height:1.65;scrollbar-width:thin;scrollbar-color:var(--red) #111;font-family:var(--font-terminal);}
#terminal::-webkit-scrollbar{width:4px}
#terminal::-webkit-scrollbar-track{background:#111}
#terminal::-webkit-scrollbar-thumb{background:var(--red)}
.line-ok{color:var(--green);}
.line-warn{color:var(--amber);}
.line-err{color:var(--red);}
.line-info{color:var(--cyan);}
.line-dim{color:var(--green-dim);}
/* ★ Ligne de commande saisie */
.line-cmd{color:var(--amber);font-family:var(--font-terminal);}
.cursor{display:inline-block;width:8px;height:14px;background:var(--green);vertical-align:text-bottom;animation:bc .7s step-end infinite;}
@keyframes bc{0%,100%{opacity:1}50%{opacity:0}}

/* ★ TURBO BOOST animation overlay */
#turbo-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  z-index:7500;pointer-events:none;display:none;
  background:radial-gradient(ellipse at center,rgba(255,26,26,.05) 0%,transparent 70%);
}
#turbo-overlay.active{display:block;animation:turboFlash .15s ease-in-out 8;}
@keyframes turboFlash{0%{background:radial-gradient(ellipse at center,rgba(255,26,26,.3) 0%,transparent 70%)}100%{background:radial-gradient(ellipse at center,rgba(255,26,26,.02) 0%,transparent 70%)}}

/* ── BUTTONS ★ AMÉLIORÉS ──────────────────────────────────── */
.btn-row{flex-shrink:0;display:flex;flex-wrap:wrap;gap:6px;padding:8px 0 6px;border-top:1px solid #1a0000;border-bottom:1px solid #1a0000;}
button{
  background:#000;border:1px solid var(--green);color:var(--green);
  padding:7px 14px;cursor:pointer;font-family:var(--font-display);font-size:10px;
  letter-spacing:1px;transition:all .15s;position:relative;overflow:hidden;
  border-radius:2px;
}
button::before{content:"";position:absolute;inset:0;background:var(--green);transform:scaleX(0);transform-origin:left;transition:transform .15s;z-index:-1;}
button:hover{color:#000;}button:hover::before{transform:scaleX(1);}
button:active{transform:scale(.95);}
/* ★ Ripple effect */
button .ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.3);transform:scale(0);animation:ripple .5s linear;pointer-events:none;}
@keyframes ripple{to{transform:scale(4);opacity:0}}
.btn-red{border-color:var(--red);color:var(--red);}
.btn-red::before{background:var(--red);}
.btn-cyan{border-color:var(--cyan);color:var(--cyan);}
.btn-cyan::before{background:var(--cyan);}

/* ── INPUT ★ AMÉLIORÉ ─────────────────────────────────────── */
.input-row{flex-shrink:0;display:flex;gap:8px;padding-top:8px;align-items:center;position:relative;}
.prompt-lbl{color:var(--red);font-size:14px;white-space:nowrap;text-shadow:0 0 8px var(--red);font-family:var(--font-display);font-weight:700;}
#cmd-input{
  flex:1;background:transparent;border:none;border-bottom:1px solid var(--green);
  color:var(--green);font-family:var(--font-terminal);font-size:17px;outline:none;
  padding:4px 0;caret-color:var(--green);
}
#cmd-input::placeholder{color:var(--green-dim);opacity:.55;}
/* ★ Hint/ghost text autocompletion */
#cmd-hint{
  position:absolute;left:0;bottom:0;
  font-family:var(--font-terminal);font-size:17px;
  color:rgba(0,255,102,.2);padding:4px 0;
  pointer-events:none;letter-spacing:0;
  white-space:nowrap;overflow:hidden;
}

/* ── MODAL ─────────────────────────────────────────────────── */
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);display:none;flex-direction:column;padding:30px;overflow:auto;z-index:5000;border:1px solid var(--red);}
.modal.open{display:flex;}
.modal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:1px solid var(--red);padding-bottom:8px;}
.modal-title{color:var(--red);font-size:16px;letter-spacing:3px;text-shadow:0 0 10px var(--red);font-family:var(--font-display);}
.close-btn{cursor:pointer;color:var(--red);font-size:20px;padding:4px 8px;border:1px solid var(--red);transition:all .15s;font-family:var(--font-display);}
.close-btn:hover{background:var(--red);color:#000;}
.modal pre{white-space:pre-wrap;color:var(--green);font-family:var(--font-mono);font-size:13px;line-height:1.7;}

/* ── TABLEAU DE BORD KITT ★ ENRICHI ─────────────────────────── */
@keyframes kScan{0%{left:4%}48%{left:calc(100% - 28px)}50%{left:calc(100% - 28px)}98%{left:4%}100%{left:4%}}
@keyframes kScanGlow{0%,48%,52%,100%{box-shadow:0 0 10px 4px rgba(255,20,0,.7),0 0 22px 8px rgba(255,20,0,.35)}49%,51%{box-shadow:0 0 14px 6px rgba(255,60,0,.9),0 0 30px 12px rgba(255,40,0,.5)}}
@keyframes dashFadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
#kitt-dash{
  position:fixed;bottom:0;left:0;right:0;height:76px;
  background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(2,0,0,.88) 30%,#060000 100%);
  z-index:110;pointer-events:none;display:none;
  border-top:1px solid rgba(255,26,26,.08);
}
#kitt-dash.visible{display:block;animation:dashFadeIn .8s ease-out forwards;}
#kitt-hood{
  position:absolute;bottom:0;left:50%;transform:translateX(-50%);
  width:min(760px,98vw);height:68px;
  background:linear-gradient(180deg,#0a0000 0%,#000 60%);
  border-radius:40% 40% 0 0 / 55% 55% 0 0;
  border-top:1px solid rgba(255,26,26,.15);
  overflow:hidden;display:flex;align-items:flex-end;justify-content:center;
  gap:0;
}
/* ★ Jauges latérales */
.kitt-gauge{
  display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
  padding-bottom:6px;min-width:54px;
  font-family:var(--font-display);font-size:7px;letter-spacing:1px;
  opacity:.8;
}
.kitt-gauge-label{color:var(--green-dim);margin-bottom:2px;}
.kitt-gauge-val{color:var(--green);text-shadow:0 0 6px var(--green);}
.kitt-gauge-bar{width:36px;height:3px;background:rgba(0,255,102,.15);border-radius:2px;overflow:hidden;margin-bottom:2px;}
.kitt-gauge-fill{height:100%;border-radius:2px;transition:width .5s ease;}
.kitt-gauge-fill.green{background:var(--green);}
.kitt-gauge-fill.amber{background:var(--amber);}
.kitt-gauge-fill.red{background:var(--red);}
/* Scanner central */
#kitt-scan-center{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;padding-bottom:4px;}
#kitt-scan-track{
  position:relative;width:85%;max-width:300px;height:6px;
  background:rgba(40,0,0,.6);border-radius:3px;
  box-shadow:inset 0 1px 3px rgba(0,0,0,.8);
}
#kitt-scan-dot{
  position:absolute;top:-1px;left:4%;
  width:24px;height:8px;border-radius:4px;
  background:linear-gradient(90deg,rgba(255,20,0,.3),#ff1a00,rgba(255,20,0,.3));
  animation:kScan 1.9s ease-in-out infinite,kScanGlow 1.9s ease-in-out infinite;
}
#kitt-scan-trail{position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent 10%,rgba(255,20,0,.04) 50%,transparent 90%);border-radius:3px;}
/* ★ SPEED display sous le scanner */
#kitt-speed-display{
  font-family:var(--font-display);font-size:9px;letter-spacing:2px;
  color:rgba(255,26,26,.4);margin-top:3px;
}

/* ── APPEL ENTRANT ─────────────────────────────────────────── */
@keyframes callRing{0%,100%{transform:scale(1)}10%,30%{transform:scale(1.04)}20%,40%{transform:scale(.98)}}
@keyframes callPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,26,26,.4)}70%{box-shadow:0 0 0 16px rgba(255,26,26,0)}}
@keyframes callIn{from{opacity:0;transform:translateX(24px)}to{opacity:1;transform:translateX(0)}}
#kitt-call{
  position:fixed;bottom:90px;right:14px;z-index:9200;
  background:rgba(2,0,0,.94);border:1px solid var(--red);border-radius:10px;
  padding:16px 20px 14px;width:min(240px,85vw);text-align:center;
  backdrop-filter:blur(10px);display:none;
  box-shadow:0 0 30px rgba(255,26,26,.25),0 4px 20px rgba(0,0,0,.6);
}
#kitt-call.active{display:block;animation:callIn .3s cubic-bezier(.34,1.56,.64,1) forwards;}
#call-avatar{
  width:48px;height:48px;border-radius:50%;border:2px solid var(--red);
  margin:0 auto 10px;display:flex;align-items:center;justify-content:center;
  font-size:13px;letter-spacing:2px;color:var(--red);background:rgba(40,0,0,.6);
  animation:callRing 1.2s ease-in-out infinite,callPulse 1.4s ease-in-out infinite;
  font-family:var(--font-display);
}
#call-name{color:var(--red);font-size:12px;letter-spacing:4px;text-shadow:0 0 14px var(--red);margin-bottom:3px;font-family:var(--font-display);}
#call-status{color:rgba(255,100,0,.7);font-size:8px;letter-spacing:3px;margin-bottom:14px;animation:bd 1.1s ease-in-out infinite;font-family:var(--font-mono);}
.call-btns{display:flex;gap:10px;justify-content:center;}
.call-btn{flex:1;padding:8px 0;border:1px solid;border-radius:5px;cursor:pointer;font-family:var(--font-display);font-size:9px;letter-spacing:2px;background:transparent;transition:all .15s;pointer-events:all;}
#call-accept{border-color:var(--green);color:var(--green);}
#call-accept:hover,#call-accept:active{background:var(--green);color:#000;}
#call-ignore{border-color:#333;color:#555;}
#call-ignore:hover,#call-ignore:active{border-color:var(--red);color:var(--red);}

/* ── TUNNEL BUTTON ─────────────────────────────────────────── */
#btn-tunnel{border-color:#333;color:#333;transition:all .2s;}
#btn-tunnel.tunnel-online{border-color:var(--green);color:var(--green);animation:tpulse 2.4s ease-in-out infinite;}
#btn-tunnel.tunnel-offline{border-color:var(--red);color:var(--red);}
#btn-tunnel.tunnel-checking{border-color:var(--amber);color:var(--amber);}
@keyframes tpulse{0%,100%{box-shadow:0 0 5px rgba(0,255,102,.25)}50%{box-shadow:0 0 18px rgba(0,255,102,.65),inset 0 0 8px rgba(0,255,102,.08)}}

/* ── CONTAINER ─────────────────────────────────────────────── */
.container{
  position:relative;z-index:1;
  display:flex;flex-direction:column;
  height:100vh;height:100dvh;
  padding:10px 16px 6px;
  max-width:760px;margin:0 auto;
  overflow:hidden;
  transition:padding-bottom .5s ease;
}
.container.dash-visible{
  padding-bottom:82px;
}

/* ── MOBILE ────────────────────────────────────────────────── */
@media(max-width:600px){
  #cmd-input{font-size:16px !important;}
  .container:not(.dash-visible){padding-bottom:max(6px,env(safe-area-inset-bottom));}
  .container.dash-visible{padding-bottom:max(88px,calc(82px + env(safe-area-inset-bottom)));}
  .input-row{padding-top:10px;padding-bottom:4px;}
  .hdr-title{font-size:10px;letter-spacing:1px;}
  button{padding:6px 10px;font-size:9px;}
  #terminal{font-size:14px;}
  #lang-box{max-width:98vw;border-radius:8px;}
  #lang-hdr{padding:12px 14px 10px;}
  .lang-logo-kitt,.lang-logo-alien{font-size:14px !important;letter-spacing:3px !important;}
  .lang-opt{padding:8px 12px;gap:10px;margin:1px 4px;}
  .lo-flag{font-size:18px !important;}
  .lo-label{font-size:11px;}
  .lo-voice-btn{font-size:9px;padding:3px 6px;}
  #lang-data-line{padding:4px 14px;font-size:8px;letter-spacing:1px;}
  #lang-ftr{padding:8px 14px;}
  #lang-screen::after{display:none;}
  #access-box{padding:20px 16px;max-width:98vw;}
  #mother-box{padding:16px 14px;}
  #mother-output{font-size:12px;min-height:200px;}
}
@media(hover:none){
  .lang-opt:hover{transform:none;box-shadow:none;}
  .lang-opt:active{background:rgba(255,26,26,.1);border-left-color:var(--red);}
}
#access-input{font-size:16px;}

/* ★ SCAN animation pour cmd scan */
@keyframes scanPulse{0%,100%{box-shadow:0 0 0 0 rgba(0,255,102,.5)}50%{box-shadow:0 0 0 20px rgba(0,255,102,0)}}
</style>
</head>
<body>

<canvas id="starfield"></canvas>

<!-- Turbo overlay -->
<div id="turbo-overlay"></div>

<!-- ÉCRAN ACCÈS -->
<div id="access-screen">
  <div id="access-box">
    <div id="access-hdr">WEYLAND-YUTANI CORP. // ACCÈS SÉCURISÉ</div>
    <div style="text-align:center;font-size:9px;letter-spacing:3px;color:#442200;margin-bottom:8px;margin-top:-8px;font-family:var(--font-mono);">&#9656; KYRONEX SYSTEMS // op. MANIX &#9666;</div>
    <div id="access-log"></div>
    <div id="access-input-row">
      <span id="access-prompt">CODE D'ACCÈS &gt;</span>
      <input id="access-input" type="password" maxlength="10" placeholder="_ _ _ _" autocomplete="off" spellcheck="false"/>
    </div>
    <div id="access-hint">ENTREZ LE CODE D'ACCÈS SYSTÈME</div>
    <!-- ★ Barre de progression -->
    <div id="access-progress"><div id="access-progress-bar"></div></div>
  </div>
</div>

<!-- MU-TH-UR 6000 INTRO -->
<div id="mother-intro" style="display:none">
  <div id="mother-box">
    <div id="mother-hdr">MU-TH-UR 6000 // WEYLAND-YUTANI CORP.</div>
    <div id="mother-output"></div>
    <div id="mother-skip">&gt;&gt;&gt; CLIQUEZ OU APPUYEZ SUR UNE TOUCHE &lt;&lt;&lt;</div>
  </div>
</div>

<!-- LANGUAGE SELECTION -->
<div id="lang-screen">
  <div class="lang-scanner-top"></div>
  <div class="lang-scanner-bot"></div>
  <div id="lang-box">
    <div class="hud-tl"></div><div class="hud-tr"></div><div class="hud-bl"></div><div class="hud-br"></div>
    <div id="lang-hdr">
      <div id="lang-logo-line">
        <span class="lang-logo-kitt">K·I·T·T</span>
        <span class="lang-logo-sep">×</span>
        <span class="lang-logo-alien">ALIEN</span>
      </div>
      <div id="lang-sys-id"></div>
    </div>
    <div id="lang-sub"></div>
    <div id="lang-output"></div>
    <div id="lang-data-line"><span id="lang-data-l">KYRONEX // NOSTROMO-180924609</span><span id="lang-data-r">op.MANIX &#9679; STAT:NOMINAL</span></div>
    <div id="lang-ftr">
      <div id="lang-ftr-left">
        <span id="lang-ftr-txt"></span>
        <button id="lang-voice-toggle" onclick="toggleLangVoice()">&#128266; VOIX</button>
      </div>
      <div id="lang-ftr-right">KYRONEX // MU-TH-UR &#9673;</div>
    </div>
  </div>
</div>

<!-- Fond Jarvis holographique -->
<svg id="jarvis-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400" preserveAspectRatio="xMidYMid meet">
  <g stroke="#00ff66" fill="none">
    <circle cx="200" cy="200" r="185" stroke-opacity="0.6" stroke-width="1"><animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200" dur="70s" repeatCount="indefinite"/></circle>
    <circle cx="200" cy="200" r="135" stroke-opacity="0.5" stroke-width="0.8"><animateTransform attributeName="transform" type="rotate" from="360 200 200" to="0 200 200" dur="45s" repeatCount="indefinite"/></circle>
    <circle cx="200" cy="200" r="85" stroke-opacity="0.45" stroke-width="0.7"><animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200" dur="32s" repeatCount="indefinite"/></circle>
    <line x1="200" y1="15" x2="200" y2="385" stroke-opacity="0.18" stroke-width="0.5"><animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200" dur="70s" repeatCount="indefinite"/></line>
    <line x1="15" y1="200" x2="385" y2="200" stroke-opacity="0.18" stroke-width="0.5"><animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200" dur="70s" repeatCount="indefinite"/></line>
    <path d="M 200 15 A 185 185 0 0 1 385 200" stroke-opacity="0.9" stroke-width="2" stroke="#00ff66"><animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200" dur="8s" repeatCount="indefinite"/></path>
    <line x1="200" y1="15" x2="200" y2="30" stroke-opacity="0.7" stroke-width="1.5"><animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200" dur="70s" repeatCount="indefinite"/></line>
    <circle cx="200" cy="200" r="5" fill="#00ff66" opacity="0.7"><animate attributeName="opacity" values="0.3;1;0.3" dur="3s" repeatCount="indefinite"/><animate attributeName="r" values="4;7;4" dur="3s" repeatCount="indefinite"/></circle>
  </g>
</svg>
<div id="sphere-wrap">
  <div id="sphere-3d">
    <div class="s-mer" style="transform:rotateY(0deg)"></div>
    <div class="s-mer" style="transform:rotateY(30deg)"></div>
    <div class="s-mer" style="transform:rotateY(60deg)"></div>
    <div class="s-mer" style="transform:rotateY(90deg)"></div>
    <div class="s-mer" style="transform:rotateY(120deg)"></div>
    <div class="s-mer" style="transform:rotateY(150deg)"></div>
    <div class="s-par" style="transform:translateY(-44px) rotateX(90deg)"></div>
    <div class="s-par" style="transform:translateY(-22px) rotateX(90deg)"></div>
    <div class="s-par" style="transform:translateY(0px) rotateX(90deg)"></div>
    <div class="s-par" style="transform:translateY(22px) rotateX(90deg)"></div>
    <div class="s-par" style="transform:translateY(44px) rotateX(90deg)"></div>
    <div class="s-core"></div>
  </div>
</div>
<div id="visit-counter"></div>
<div id="site-footer">v3.1 &nbsp;—&nbsp; DERNIÈRE MISE À JOUR : 2026-02-23</div>

<!-- Scanners -->
<div id="sw"><div id="sb"></div></div>
<div id="swb"><div id="sbb"></div></div>

<div class="container">
  <header>
    <div id="hdr-title" class="hdr-title">KITT FRANCO-BELGE // INTERFACE CENTRALE</div>
    <div class="hdr-right">
      <!-- ★ Mode badge -->
      <span id="kitt-mode-badge" class="normal">NORMAL</span>
      <span id="lang-flag" onclick="showLangScreen()" title="Changer de langue">FR</span>
      <span class="hdr-indicator">
        <span class="hdr-dot green" id="net-dot"></span>
        <span id="status-txt">EN LIGNE</span>
      </span>
      <span id="clock">00:00:00</span>
    </div>
  </header>

  <div id="terminal"></div>

  <div class="btn-row">
    <button id="btn-boot" onclick="ripple(event);boot()">[ INITIALISER ]</button>
    <button id="btn-diag" onclick="ripple(event);runSelfTest()" class="btn-cyan">[ DIAGNOSTIC ]</button>
    <button id="btn-mentions" onclick="ripple(event);openFile('Mentions.txt',T[LANG].modal_mentions)" class="btn-red">[ MENTIONS ]</button>
    <button id="btn-licence" onclick="ripple(event);openFile('License.txt',T[LANG].modal_licence)" class="btn-red">[ LICENCE ]</button>
    <button id="btn-clear" onclick="ripple(event);clearTerm()">[ EFFACER ]</button>
    <button id="btn-tunnel" class="tunnel-checking" onclick="ripple(event);connectTunnel()" title="Vérification..."><span id="btn-tunnel-txt">[ CONNEXION KITT ]</span></button>
  </div>

  <div class="input-row">
    <span class="prompt-lbl">KITT&gt;</span>
    <div style="flex:1;position:relative;">
      <input id="cmd-input" type="text" placeholder="entrez une commande..." autocomplete="off" spellcheck="false"/>
      <div id="cmd-hint"></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-hdr">
    <span class="modal-title" id="modal-title">DOCUMENT</span>
    <span class="close-btn" onclick="closeModal()">&#10006;</span>
  </div>
  <pre id="modal-content"></pre>
</div>

<script>
// ════════════════════════════════════════════════════════════
// AUDIO ENGINE
// ════════════════════════════════════════════════════════════
const _ac = new (window.AudioContext || window.webkitAudioContext)();
function _resume() { if (_ac.state === 'suspended') _ac.resume(); }

function sndClick() {
  try {
    _resume(); const t = _ac.currentTime;
    const len = Math.floor(_ac.sampleRate * 0.020);
    const buf = _ac.createBuffer(1, len, _ac.sampleRate);
    const d = buf.getChannelData(0);
    for (let i = 0; i < len; i++) d[i] = (Math.random()*2-1) * Math.pow(1-i/len, 3.5);
    const src = _ac.createBufferSource(); src.buffer = buf;
    const bp = _ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2700+Math.random()*400; bp.Q.value=4;
    const hp = _ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=850;
    const g = _ac.createGain(); g.gain.value=0.25;
    src.connect(bp); bp.connect(hp); hp.connect(g); g.connect(_ac.destination); src.start(t);
    const o = _ac.createOscillator(); o.type='square';
    o.frequency.setValueAtTime(1350+Math.random()*200, t);
    o.frequency.exponentialRampToValueAtTime(680, t+0.017);
    const og = _ac.createGain(); og.gain.setValueAtTime(0.04, t); og.gain.exponentialRampToValueAtTime(0.001, t+0.020);
    o.connect(og); og.connect(_ac.destination); o.start(t); o.stop(t+0.022);
  } catch(e){}
}
function sndTick() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type='triangle';
    o.frequency.setValueAtTime(3800+Math.random()*400, t);
    o.frequency.exponentialRampToValueAtTime(2400, t+0.012);
    const g = _ac.createGain(); g.gain.setValueAtTime(0.03, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.015);
    o.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t+0.016);
  } catch(e){}
}
function sndData() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type='sawtooth';
    o.frequency.value = 1800 + Math.random()*600;
    const g = _ac.createGain(); g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.012);
    const lp = _ac.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=4000;
    o.connect(lp); lp.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t+0.013);
  } catch(e){}
}
function sndGlitch() {
  try {
    _resume(); const t = _ac.currentTime;
    const len = Math.floor(_ac.sampleRate * 0.035);
    const buf = _ac.createBuffer(1, len, _ac.sampleRate);
    const d = buf.getChannelData(0);
    for (let i = 0; i < len; i++) d[i] = (Math.random()*2-1) * (Math.random() > 0.5 ? 0.9 : 0.05);
    const src = _ac.createBufferSource(); src.buffer=buf;
    const bp = _ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1200; bp.Q.value=2;
    const g = _ac.createGain(); g.gain.value=0.12;
    src.connect(bp); bp.connect(g); g.connect(_ac.destination); src.start(t);
  } catch(e){}
}
function sndLineEnd() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type='sine';
    o.frequency.setValueAtTime(840, t); o.frequency.exponentialRampToValueAtTime(320, t+0.10);
    const g = _ac.createGain(); g.gain.setValueAtTime(0.032, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.11);
    o.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t+0.12);
    const o2 = _ac.createOscillator(); o2.type='sine'; o2.frequency.value=80;
    const g2 = _ac.createGain(); g2.gain.setValueAtTime(0.015, t); g2.gain.exponentialRampToValueAtTime(0.001, t+0.08);
    o2.connect(g2); g2.connect(_ac.destination); o2.start(t); o2.stop(t+0.09);
  } catch(e){}
}
function sndSelect() {
  try {
    _resume(); const t = _ac.currentTime;
    [440,660,880].forEach((f,i) => {
      const o = _ac.createOscillator(); o.type='square'; o.frequency.value=f;
      const g = _ac.createGain(); g.gain.setValueAtTime(0.04, t+i*0.06); g.gain.exponentialRampToValueAtTime(0.001, t+i*0.06+0.05);
      o.connect(g); g.connect(_ac.destination); o.start(t+i*0.06); o.stop(t+i*0.06+0.055);
    });
  } catch(e){}
}
function sndError() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type='square'; o.frequency.value=180;
    const g = _ac.createGain(); g.gain.setValueAtTime(0.07, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.08);
    o.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t+0.09);
  } catch(e){}
}
function kittChime() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type='sine';
    o.frequency.setValueAtTime(880, t); o.frequency.exponentialRampToValueAtTime(220, t+0.35);
    const g = _ac.createGain(); g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.4);
    o.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t+0.4);
  } catch(e){}
}
// ★ Son turbo boost
function sndTurbo() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type='sawtooth';
    o.frequency.setValueAtTime(80, t); o.frequency.exponentialRampToValueAtTime(2400, t+0.6);
    const lp = _ac.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(400, t); lp.frequency.exponentialRampToValueAtTime(8000, t+0.6);
    const g = _ac.createGain(); g.gain.setValueAtTime(0.15, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.65);
    o.connect(lp); lp.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t+0.7);
    // Noise burst
    const len = Math.floor(_ac.sampleRate * 0.4);
    const buf = _ac.createBuffer(1, len, _ac.sampleRate);
    const d = buf.getChannelData(0);
    for (let i = 0; i < len; i++) d[i] = (Math.random()*2-1) * Math.pow(1-i/len, 1.5);
    const src = _ac.createBufferSource(); src.buffer = buf;
    const hp = _ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
    const ng = _ac.createGain(); ng.gain.value=0.06;
    src.connect(hp); hp.connect(ng); ng.connect(_ac.destination); src.start(t+0.1);
  } catch(e){}
}
// ★ Son scan
function sndScan() {
  try {
    _resume(); const t = _ac.currentTime;
    for (let i = 0; i < 5; i++) {
      const o = _ac.createOscillator(); o.type='sine';
      o.frequency.setValueAtTime(600 + i*200, t + i*0.12);
      o.frequency.exponentialRampToValueAtTime(1200 + i*100, t + i*0.12 + 0.1);
      const g = _ac.createGain(); g.gain.setValueAtTime(0.04, t+i*0.12); g.gain.exponentialRampToValueAtTime(0.001, t+i*0.12+0.12);
      o.connect(g); g.connect(_ac.destination); o.start(t+i*0.12); o.stop(t+i*0.12+0.13);
    }
  } catch(e){}
}

function sndMotherClick() {
  try {
    _resume(); const t = _ac.currentTime;
    const buf = _ac.createBuffer(1, _ac.sampleRate * 0.06, _ac.sampleRate);
    const d = buf.getChannelData(0);
    for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (d.length * 0.3));
    const src = _ac.createBufferSource(); src.buffer = buf;
    const lp = _ac.createBiquadFilter(); lp.type = 'lowpass'; lp.frequency.value = 800;
    const g = _ac.createGain(); g.gain.setValueAtTime(0.18, t);
    src.connect(lp); lp.connect(g); g.connect(_ac.destination); src.start(t);
  } catch(e){}
}
function sndMotherBeep() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type = 'sine';
    o.frequency.setValueAtTime(330, t); o.frequency.linearRampToValueAtTime(440, t + 0.1);
    const g = _ac.createGain(); g.gain.setValueAtTime(0.09, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
    o.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t + 0.13);
  } catch(e){}
}
function sndMotherScan() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type = 'sawtooth';
    o.frequency.setValueAtTime(180, t); o.frequency.linearRampToValueAtTime(360, t + 0.4);
    const lp = _ac.createBiquadFilter(); lp.type = 'lowpass'; lp.frequency.value = 900;
    const g = _ac.createGain(); g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.45);
    o.connect(lp); lp.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t + 0.45);
  } catch(e){}
}
function sndMotherChime() {
  try {
    _resume(); const t = _ac.currentTime;
    [220, 330, 440].forEach((freq, i) => {
      const o = _ac.createOscillator(); o.type = 'sine'; o.frequency.value = freq;
      const g = _ac.createGain(); const s = t + i * 0.22;
      g.gain.setValueAtTime(0, s); g.gain.linearRampToValueAtTime(0.12, s + 0.06);
      g.gain.exponentialRampToValueAtTime(0.001, s + 0.38);
      o.connect(g); g.connect(_ac.destination); o.start(s); o.stop(s + 0.4);
    });
  } catch(e){}
}
function sndMutherBeep() {
  try {
    _resume(); const t = _ac.currentTime;
    const o = _ac.createOscillator(); o.type='sine';
    o.frequency.setValueAtTime(1480, t); o.frequency.setValueAtTime(1120, t+0.05);
    const g = _ac.createGain(); g.gain.setValueAtTime(0.06, t); g.gain.setValueAtTime(0.06, t+0.05); g.gain.exponentialRampToValueAtTime(0.001, t+0.12);
    const hp = _ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=900;
    o.connect(hp); hp.connect(g); g.connect(_ac.destination); o.start(t); o.stop(t+0.13);
  } catch(e){}
}

const SPECIAL_CHARS = new Set([...'[]():=|─══╔╗╚╝║┌┐└┘├┤•★']);
let _charCount = 0;
function playChar(ch) {
  if (ch === ' ' || ch === '\n') return;
  _charCount++;
  const r = Math.random();
  if (SPECIAL_CHARS.has(ch)) { sndData(); return; }
  if (_charCount % 47 === 0) { sndGlitch(); return; }
  if (r < 0.03) { sndGlitch(); return; }
  if (r < 0.14) { sndTick(); return; }
  if (r < 0.72) { sndClick(); return; }
}

// ════════════════════════════════════════════════════════════
// ★ RIPPLE EFFECT
// ════════════════════════════════════════════════════════════
function ripple(e) {
  const btn = e.currentTarget;
  const circle = document.createElement('span');
  const diameter = Math.max(btn.clientWidth, btn.clientHeight);
  const radius = diameter / 2;
  const rect = btn.getBoundingClientRect();
  circle.style.width = circle.style.height = diameter + 'px';
  circle.style.left = (e.clientX - rect.left - radius) + 'px';
  circle.style.top = (e.clientY - rect.top - radius) + 'px';
  circle.classList.add('ripple');
  const existing = btn.querySelector('.ripple');
  if (existing) existing.remove();
  btn.appendChild(circle);
}

// ════════════════════════════════════════════════════════════
// ★ MODE KITT
// ════════════════════════════════════════════════════════════
let kittMode = 'normal';
const MODES = ['normal', 'pursuit', 'turbo'];
const MODE_LABELS = { normal: 'NORMAL', pursuit: 'S.POURSUITE', turbo: 'TURBO BOOST' };
let kittSpeed = 0;
let speedInterval = null;

function setKittMode(mode) {
  kittMode = mode;
  const badge = document.getElementById('kitt-mode-badge');
  if (badge) {
    badge.className = mode;
    badge.textContent = MODE_LABELS[mode] || mode.toUpperCase();
  }
  // ★ Update speed gauge
  const speedEl = document.getElementById('kitt-speed-display');
  if (speedEl) {
    if (mode === 'normal') kittSpeed = 0;
    else if (mode === 'pursuit') kittSpeed = 220;
    else kittSpeed = 480;
    speedEl.textContent = mode !== 'normal' ? kittSpeed + ' KM/H' : '';
  }
}

// ════════════════════════════════════════════════════════════
// MU-TH-UR 6000 INTRO
// ════════════════════════════════════════════════════════════
function motherSpeak(text, onEnd) {
  if (!window.speechSynthesis) { if (onEnd) onEnd(); return; }
  speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = 'fr-FR'; utt.rate = 0.72; utt.pitch = 0.5; utt.volume = 0.85;
  if (onEnd) utt.onend = onEnd;
  const loadVoices = () => {
    const voices = speechSynthesis.getVoices();
    const v = voices.find(v => v.lang.startsWith('fr') && v.name.toLowerCase().includes('female')) || voices.find(v => v.lang.startsWith('fr'));
    if (v) utt.voice = v;
    speechSynthesis.speak(utt);
  };
  if (speechSynthesis.getVoices().length > 0) loadVoices();
  else { speechSynthesis.onvoiceschanged = loadVoices; speechSynthesis.speak(utt); }
}

async function runMotherIntro() {
  const intro = document.getElementById('mother-intro');
  const output = document.getElementById('mother-output');
  const skipMsg = document.getElementById('mother-skip');
  intro.style.display = 'flex';
  let skipped = false;
  const skipHandler = () => { skipped = true; };
  document.addEventListener('click', skipHandler, { once: true });
  document.addEventListener('keydown', skipHandler, { once: true });
  const delay = ms => new Promise(resolve => {
    if (skipped) { resolve(); return; }
    const t = setTimeout(resolve, ms);
    const check = setInterval(() => { if (skipped) { clearTimeout(t); clearInterval(check); resolve(); } }, 50);
  });
  function addLine(text, cls) {
    const div = document.createElement('div'); div.className = cls || 'm-normal';
    output.appendChild(div); return div;
  }
  async function typeMotherLine(text, cls, speed) {
    if (skipped) { addLine(text, cls); return; }
    const div = addLine('', cls);
    for (let i = 0; i < text.length; i++) {
      if (skipped) { div.textContent = text; return; }
      div.textContent += text[i];
      if (text[i] !== ' ') sndMotherClick();
      await delay(speed || 18);
    }
    sndMotherBeep();
  }
  await typeMotherLine('WEYLAND-YUTANI CORPORATION', 'm-bright', 18);
  await delay(120);
  await typeMotherLine('SYSTÈME  :  MU-TH-UR 6000', 'm-normal', 18);
  await delay(80);
  await typeMotherLine('ACCÈS    :  PROTOCOLE D\'INTERFACE', 'm-normal', 18);
  await delay(300);
  addLine('', 'm-dim');
  await delay(200);
  await typeMotherLine('NAVIRE   :  NOSTROMO  180924609', 'm-normal', 16);
  await delay(80);
  await typeMotherLine('CLASSE   :  VÉHICULE DE REMORQUAGE COM', 'm-dim', 14);
  await delay(80);
  await typeMotherLine('ÉQUIPAGE :  7 MEMBRES', 'm-dim', 16);
  await delay(80);
  await typeMotherLine('OPÉRATEUR:  MANIX  //  KYRONEX SYSTEMS', 'm-dim', 14);
  await delay(400);
  addLine('', 'm-dim');
  const checks = [
    ['VÉRIFICATION SYSTÈMES', '[OK]'],
    ['NOYAU NEURAL         ', '[EN LIGNE]'],
    ['MÉMOIRE PERSISTANTE  ', '[STABLE]'],
    ['MODULE KYRONEX       ', '[ACTIF]'],
    ['RÉSEAU KITT          ', '[CHARGÉE]'],
  ];
  for (const [label, result] of checks) {
    if (skipped) { addLine(label + ' ...... ' + result, 'm-ok'); continue; }
    const div = addLine(label + ' ......', 'm-dim');
    sndMotherScan();
    await delay(420);
    div.className = 'm-ok';
    div.textContent = label + ' ...... ' + result;
    await delay(80);
  }
  if (!skipped) { await delay(700); sndMotherChime(); await delay(900); }
  if (!skipped) {
    await new Promise(resolve => {
      motherSpeak("PROTOCOLE D'INTERFACE ACTIVÉ. MODULE KYRONEX EN LIGNE. JE SUIS MU-TH-UR. VOUS POUVEZ PROCÉDER.", resolve);
    });
  }
  skipMsg.style.display = 'block';
  document.removeEventListener('click', skipHandler);
  document.removeEventListener('keydown', skipHandler);
  if (!skipped) await delay(3000);
  intro.style.transition = 'opacity 0.8s';
  intro.style.opacity = '0';
  await new Promise(resolve => setTimeout(resolve, 820));
  intro.style.display = 'none';
  intro.style.opacity = '';
  intro.style.transition = '';
  showLangScreen();
}

// ════════════════════════════════════════════════════════════
// LANGUE
// ════════════════════════════════════════════════════════════
let LANG = 'fr';
const T = {
  fr: {
    hdr_title:'KITT FRANCO-BELGE // INTERFACE CENTRALE',
    placeholder:'entrez une commande...',
    btn_boot:'[ INITIALISER ]',btn_diag:'[ DIAGNOSTIC ]',btn_mentions:'[ MENTIONS ]',
    btn_licence:'[ LICENCE ]',btn_clear:'[ EFFACER ]',btn_tunnel:'[ CONNEXION KITT ]',
    modal_mentions:'MENTIONS LÉGALES',modal_licence:'LICENCE',
    wait:'SYSTÈME EN ATTENTE — TAPEZ "boot" OU CLIQUEZ [ INITIALISER ]',
    help_hint:'TAPEZ "aide" POUR LA LISTE DES COMMANDES.',
    cleared:'TERMINAL EFFACÉ.',
    unknown:(c) => `COMMANDE INCONNUE : "${c}". TAPEZ "aide".`,
    online:'EN LIGNE',
    boot_title:'  KITT FRANCO-BELGE — SÉQUENCE DE BOOT   ',
    boot_lines:[
      ['INITIALISATION DU NOYAU SYSTÈME...','line-warn'],
      ['CHARGEMENT MODULES COGNITIFS...    [OK]','line-ok'],
      ['INTERFACE NEURONALE...             [OK]','line-ok'],
      ['SYNTHÈSE VOCALE (PIPER-GPU)...     [OK]','line-ok'],
      ['RECONNAISSANCE VOCALE (WHISPER)... [OK]','line-ok'],
      ['MODÈLE LLM EMBARQUÉ (QWEN 3B)...  [OK]','line-ok'],
      ['MODE HORS-LIGNE...                 [ACTIVÉ]','line-ok'],
      ['','line-ok'],
      ['PROJET FAN NON COMMERCIAL.','line-dim'],
      ['STATUT : INTERFACE EN CONSTRUCTION ACTIVE.','line-warn'],
      ['','line-ok'],
      ['MISES À JOUR DÉPLOYÉES RÉGULIÈREMENT :','line-info'],
      ['  • parfois chaque jour','line-dim'],
      ['  • parfois chaque semaine','line-dim'],
      ['  • lors de certaines phases, presque heure par heure','line-dim'],
      ['','line-ok'],
      ['© 2026 EMMANUEL GELINNE (MANIX). TOUS DROITS RÉSERVÉS.','line-warn'],
    ],
    boot_end:'  CONNEXION AU NOYAU KITT ÉTABLIE.',
    boot_hint:'  TAPEZ "aide" POUR LA LISTE DES COMMANDES',
    aide_title:'COMMANDES DISPONIBLES :',
    aide_sys:'── SYSTÈME ──',aide_fun:'── FUN ──',
    cmds_sys:[
      ['aide','cette liste'],['boot',"séquence d'initialisation"],
      ['diagnostic','test complet des systèmes'],['status','état rapide'],
      ['heure','heure actuelle'],['version',"version de l'interface"],
      ['son','démo audio'],['clear','efface le terminal'],
      ['mode','changer le mode KITT ★'],['turbo','TURBO BOOST ★'],
      ['scan','scanner l\'environnement ★'],['vitesse','afficher la vitesse ★'],
    ],
    cmds_fun:[
      ['bonjour','salutation KITT'],['blague','blague KITT aléatoire'],
      ['alien','connexion MU-TH-UR 6000'],['matrix','le lapin blanc'],
      ['kitt','fiche identité KITT'],['manix','dossier conducteur'],
      ['cedric','dossier Cedric Momo Rider'],['kr95','dossier KR95'],
      ['repliques','les répliques franco-belges'],['secret','fichier classifié...'],
      ['cafe','demander un café à KITT'],['belgique','analyse géopolitique'],
      ['jarvis','appel vers Stark Tower'],['mario','dossier Mario Ravasi / IoT'],
      ['za','dossier ZA Elettronica'],['pascal','dossier K Industrie'],
      ['daemon','dossier Daemon Paule'],['geoffrey','dossier Geoffrey'],
      ['covid','origine du projet — confinement 2020'],['karr','dossier K.A.R.R. ★'],
      ['credits','crédits du projet ★'],
    ],
    hi:'BONJOUR. JE SUIS KITT — KNIGHT INDUSTRIES TWO THOUSAND.',
    hi2:'SYSTÈME FRANCO-BELGE DÉVELOPPÉ PAR MANIX.',
    hi3:'À VOTRE SERVICE.',
  },
  en: {
    hdr_title:'KITT FRANCO-BELGIAN // CENTRAL INTERFACE',
    placeholder:'enter a command...',
    btn_boot:'[ INITIALIZE ]',btn_diag:'[ DIAGNOSTIC ]',btn_mentions:'[ MENTIONS ]',
    btn_licence:'[ LICENSE ]',btn_clear:'[ CLEAR ]',btn_tunnel:'[ CONNECT KITT ]',
    modal_mentions:'LEGAL NOTICES',modal_licence:'LICENSE',
    wait:'SYSTEM STANDBY — TYPE "boot" OR CLICK [ INITIALIZE ]',
    help_hint:'TYPE "help" FOR THE LIST OF COMMANDS.',
    cleared:'TERMINAL CLEARED.',
    unknown:(c) => `UNKNOWN COMMAND: "${c}". TYPE "help".`,
    online:'ONLINE',
    boot_title:'  KITT FRANCO-BELGE — BOOT SEQUENCE        ',
    boot_lines:[
      ['INITIALIZING CORE SYSTEM...','line-warn'],
      ['LOADING COGNITIVE MODULES...       [OK]','line-ok'],
      ['NEURAL INTERFACE...                [OK]','line-ok'],
      ['VOICE SYNTHESIS (PIPER-GPU)...     [OK]','line-ok'],
      ['VOICE RECOGNITION (WHISPER)...     [OK]','line-ok'],
      ['EMBEDDED LLM (QWEN 3B)...          [OK]','line-ok'],
      ['OFFLINE MODE...                    [ACTIVE]','line-ok'],
      ['','line-ok'],
      ['FAN PROJECT — NON COMMERCIAL.','line-dim'],
      ['STATUS : INTERFACE UNDER ACTIVE CONSTRUCTION.','line-warn'],
      ['','line-ok'],
      ['UPDATES DEPLOYED REGULARLY :','line-info'],
      ['  • sometimes every day','line-dim'],
      ['  • sometimes every week','line-dim'],
      ['  • during some phases, almost hour by hour','line-dim'],
      ['','line-ok'],
      ['© 2026 EMMANUEL GELINNE (MANIX). ALL RIGHTS RESERVED.','line-warn'],
    ],
    boot_end:'  CONNECTION TO KITT CORE ESTABLISHED.',
    boot_hint:'  TYPE "help" FOR THE COMMAND LIST',
    aide_title:'AVAILABLE COMMANDS:',aide_sys:'── SYSTEM ──',aide_fun:'── FUN ──',
    cmds_sys:[
      ['help','this list'],['boot','boot sequence'],
      ['diagnostic','full system test'],['status','quick status'],
      ['time','current time'],['version','interface version'],
      ['sound','audio demo'],['clear','clear terminal'],
      ['mode','change KITT mode ★'],['turbo','TURBO BOOST ★'],
      ['scan','scan environment ★'],['speed','display speed ★'],
    ],
    cmds_fun:[
      ['hello','KITT greeting'],['joke','random KITT joke'],
      ['alien','MU-TH-UR 6000 connection'],['matrix','the white rabbit'],
      ['kitt','KITT identity file'],['manix','driver file'],
      ['cedric','Cedric Momo Rider file'],['kr95','KR95 file'],
      ['replicas','the franco-belgian replicas'],['secret','classified file...'],
      ['coffee','ask KITT for a coffee'],['belgium','geopolitical analysis'],
      ['jarvis','call to Stark Tower'],['mario','Mario Ravasi / IoT file'],
      ['za','ZA Elettronica file'],['pascal','K Industrie file'],
      ['daemon','Daemon Paule file'],['geoffrey','Geoffrey file'],
      ['covid','project origin — lockdown 2020'],['karr','K.A.R.R. file ★'],
      ['credits','project credits ★'],
    ],
    hi:'HELLO. I AM KITT — KNIGHT INDUSTRIES TWO THOUSAND.',
    hi2:'FRANCO-BELGIAN SYSTEM DEVELOPED BY MANIX.',
    hi3:'AT YOUR SERVICE.',
  },
  nl:{hdr_title:'KITT FRANCO-BELGISCH // CENTRALE INTERFACE',placeholder:'voer een commando in...',btn_boot:'[ OPSTARTEN ]',btn_diag:'[ DIAGNOSE ]',btn_mentions:'[ VERMELDINGEN ]',btn_licence:'[ LICENTIE ]',btn_clear:'[ WISSEN ]',btn_tunnel:'[ VERBIND KITT ]',modal_mentions:'WETTELIJKE VERMELDINGEN',modal_licence:'LICENTIE',wait:'SYSTEEM WACHT — TYP "boot" OF KLIK [ OPSTARTEN ]',help_hint:'TYP "hulp" VOOR DE COMMANDOLIJST.',cleared:'TERMINAL GEWIST.',unknown:(c)=>`ONBEKEND COMMANDO: "${c}". TYP "hulp".`,online:'ONLINE',boot_title:'  KITT FRANCO-BELGE — OPSTARTSEQUENTIE     ',boot_lines:[['KERNSYSTEEM INITIALISEREN...','line-warn'],['COGNITIEVE MODULES LADEN...        [OK]','line-ok'],['NEURALE INTERFACE...               [OK]','line-ok'],['SPRAAKSYNTHESE (PIPER-GPU)...      [OK]','line-ok'],['STEMHERKENNING (WHISPER)...        [OK]','line-ok'],['EMBEDDED LLM (QWEN 3B)...          [OK]','line-ok'],['OFFLINE MODUS...                   [ACTIEF]','line-ok'],['','line-ok'],['FAN PROJECT — NIET COMMERCIEEL.','line-dim'],['STATUS : INTERFACE IN ACTIEVE CONSTRUCTIE.','line-warn'],['','line-ok'],['UPDATES REGELMATIG UITGEROLD :','line-info'],['  • soms elke dag','line-dim'],['  • soms elke week','line-dim'],['  • soms elk uur','line-dim'],['','line-ok'],['© 2026 EMMANUEL GELINNE (MANIX). ALLE RECHTEN VOORBEHOUDEN.','line-warn']],boot_end:'  VERBINDING MET KITT-KERN TOT STAND GEBRACHT.',boot_hint:'  TYP "hulp" VOOR DE COMMANDOLIJST',aide_title:'BESCHIKBARE COMMANDO\'S:',aide_sys:'── SYSTEEM ──',aide_fun:'── PLEZIER ──',cmds_sys:[['hulp','deze lijst'],['boot','opstartsequentie'],['diagnostic','volledig systeemtest'],['status','snelle status'],['tijd','huidige tijd'],['versie','interface versie'],['geluid','audio demo'],['clear','terminal wissen'],['mode','KITT-modus wijzigen ★'],['turbo','TURBO BOOST ★'],['scan','omgeving scannen ★'],['snelheid','snelheid weergeven ★']],cmds_fun:[['hallo','KITT begroeting'],['grap','willekeurige KITT grap'],['alien','MU-TH-UR 6000 verbinding'],['matrix','het witte konijn'],['kitt','KITT identiteitsbestand'],['manix','bestuurdersdossier'],['cedric','Cedric Momo Rider dossier'],['kr95','KR95 dossier'],['replicas','de franco-belgische replica\'s'],['geheim','geheim bestand...'],['koffie','KITT om koffie vragen'],['belgie','geopolitieke analyse'],['jarvis','oproep naar Stark Tower'],['mario','Mario Ravasi / IoT dossier'],['za','ZA Elettronica dossier'],['pascal','K Industrie dossier'],['daemon','Daemon Paule dossier'],['geoffrey','Geoffrey dossier'],['covid','projectoorsprong — lockdown 2020'],['karr','K.A.R.R. dossier ★'],['credits','projectcredits ★']],hi:'HALLO. IK BEN KITT — KNIGHT INDUSTRIES TWO THOUSAND.',hi2:'FRANCO-BELGISCH SYSTEEM ONTWIKKELD DOOR MANIX.',hi3:'TOT UW DIENST.'},
  it:{hdr_title:'KITT FRANCO-BELGA // INTERFACCIA CENTRALE',placeholder:'inserisci un comando...',btn_boot:'[ INIZIALIZZA ]',btn_diag:'[ DIAGNOSI ]',btn_mentions:'[ MENZIONI ]',btn_licence:'[ LICENZA ]',btn_clear:'[ CANCELLA ]',btn_tunnel:'[ CONNETTI KITT ]',modal_mentions:'NOTE LEGALI',modal_licence:'LICENZA',wait:'SISTEMA IN ATTESA — DIGITA "boot" O CLICCA [ INIZIALIZZA ]',help_hint:'DIGITA "aiuto" PER LA LISTA DEI COMANDI.',cleared:'TERMINALE CANCELLATO.',unknown:(c)=>`COMANDO SCONOSCIUTO: "${c}". DIGITA "aiuto".`,online:'IN LINEA',boot_title:'  KITT FRANCO-BELGA — SEQUENZA DI AVVIO     ',boot_lines:[['INIZIALIZZAZIONE SISTEMA...','line-warn'],['CARICAMENTO MODULI COGNITIVI...    [OK]','line-ok'],['INTERFACCIA NEURALE...             [OK]','line-ok'],['SINTESI VOCALE (PIPER-GPU)...      [OK]','line-ok'],['RICONOSCIMENTO VOCALE (WHISPER)... [OK]','line-ok'],['MODELLO LLM LOCALE (QWEN 3B)...   [OK]','line-ok'],['MODALITÀ OFFLINE...                [ATTIVA]','line-ok'],['','line-ok'],['PROGETTO FAN — NON COMMERCIALE.','line-dim'],['STATO : INTERFACCIA IN COSTRUZIONE ATTIVA.','line-warn'],['','line-ok'],['AGGIORNAMENTI DISTRIBUITI REGOLARMENTE :','line-info'],['  • a volte ogni giorno','line-dim'],['  • a volte ogni settimana','line-dim'],['  • in alcune fasi, quasi ogni ora','line-dim'],['','line-ok'],['© 2026 EMMANUEL GELINNE (MANIX). TUTTI I DIRITTI RISERVATI.','line-warn']],boot_end:'  CONNESSIONE AL NUCLEO KITT STABILITA.',boot_hint:'  DIGITA "aiuto" PER LA LISTA DEI COMANDI',aide_title:'COMANDI DISPONIBILI:',aide_sys:'── SISTEMA ──',aide_fun:'── DIVERTIMENTO ──',cmds_sys:[['aiuto','questa lista'],['boot','sequenza di avvio'],['diagnostic','test completo del sistema'],['status','stato rapido'],['ora','ora corrente'],['version','versione interfaccia'],['suono','demo audio'],['clear','cancella terminale'],['mode','cambia modalità KITT ★'],['turbo','TURBO BOOST ★'],['scan','scansiona ambiente ★'],['velocita','visualizza velocità ★']],cmds_fun:[['ciao','saluto KITT'],['barzelletta','barzelletta casuale KITT'],['alien','connessione MU-TH-UR 6000'],['matrix','il coniglio bianco'],['kitt','scheda identità KITT'],['manix','dossier pilota'],['cedric','dossier Cedric Momo Rider'],['kr95','dossier KR95'],['replicas','le repliche franco-belghe'],['segreto','file classificato...'],['caffe','chiedere un caffè a KITT'],['belgio','analisi geopolitica'],['jarvis','chiamata verso Stark Tower'],['mario','dossier Mario Ravasi / IoT'],['za','dossier ZA Elettronica'],['pascal','dossier K Industrie'],['daemon','dossier Daemon Paule'],['geoffrey','dossier Geoffrey'],['covid','origine del progetto — lockdown 2020'],['karr','dossier K.A.R.R. ★'],['credits','crediti del progetto ★']],hi:'CIAO. SONO KITT — KNIGHT INDUSTRIES TWO THOUSAND.',hi2:'SISTEMA FRANCO-BELGA SVILUPPATO DA MANIX.',hi3:'AL VOSTRO SERVIZIO.'},
  de:{hdr_title:'KITT FRANCO-BELGISCH // ZENTRALE SCHNITTSTELLE',placeholder:'Befehl eingeben...',btn_boot:'[ INITIALISIEREN ]',btn_diag:'[ DIAGNOSE ]',btn_mentions:'[ IMPRESSUM ]',btn_licence:'[ LIZENZ ]',btn_clear:'[ LÖSCHEN ]',btn_tunnel:'[ KITT VERBINDEN ]',modal_mentions:'IMPRESSUM',modal_licence:'LIZENZ',wait:'SYSTEM BEREIT — TIPPE "boot" ODER KLICKE [ INITIALISIEREN ]',help_hint:'TIPPE "hilfe" FÜR DIE BEFEHLSLISTE.',cleared:'TERMINAL GELEERT.',unknown:(c)=>`UNBEKANNTER BEFEHL: "${c}". TIPPE "hilfe".`,online:'ONLINE',boot_title:'  KITT FRANCO-BELGISCH — STARTSEQUENZ        ',boot_lines:[['KERNSYSTEM WIRD INITIALISIERT...','line-warn'],['KOGNITIVE MODULE LADEN...          [OK]','line-ok'],['NEURONALE SCHNITTSTELLE...         [OK]','line-ok'],['SPRACHSYNTHESE (PIPER-GPU)...      [OK]','line-ok'],['SPRACHERKENNUNG (WHISPER)...       [OK]','line-ok'],['LOKALES LLM (QWEN 3B)...           [OK]','line-ok'],['OFFLINE-MODUS...                   [AKTIV]','line-ok'],['','line-ok'],['FAN-PROJEKT — NICHT KOMMERZIELL.','line-dim'],['STATUS : SCHNITTSTELLE IM AUFBAU.','line-warn'],['','line-ok'],['UPDATES REGELMÄSSIG VERFÜGBAR :','line-info'],['  • manchmal täglich','line-dim'],['  • manchmal wöchentlich','line-dim'],['  • manchmal stündlich','line-dim'],['','line-ok'],['© 2026 EMMANUEL GELINNE (MANIX). ALLE RECHTE VORBEHALTEN.','line-warn']],boot_end:'  VERBINDUNG ZUM KITT-KERN HERGESTELLT.',boot_hint:'  TIPPE "hilfe" FÜR DIE BEFEHLSLISTE',aide_title:'VERFÜGBARE BEFEHLE:',aide_sys:'── SYSTEM ──',aide_fun:'── SPASS ──',cmds_sys:[['hilfe','diese Liste'],['boot','Startsequenz'],['diagnostic','vollständiger Systemtest'],['status','schneller Status'],['uhrzeit','aktuelle Uhrzeit'],['version','Schnittstellenversion'],['ton','Audio-Demo'],['clear','Terminal leeren'],['mode','KITT-Modus ändern ★'],['turbo','TURBO BOOST ★'],['scan','Umgebung scannen ★'],['geschwindigkeit','Geschwindigkeit anzeigen ★']],cmds_fun:[['hallo','KITT-Begrüßung'],['witz','zufälliger KITT-Witz'],['alien','MU-TH-UR 6000 Verbindung'],['matrix','das weiße Kaninchen'],['kitt','KITT Identitätsakte'],['manix','Fahrerakte'],['cedric','Cedric Momo Rider Akte'],['kr95','KR95 Akte'],['replicas','die franco-belgischen Repliken'],['geheimnis','geheime Akte...'],['kaffee','KITT um Kaffee bitten'],['belgien','geopolitische Analyse'],['jarvis','Anruf bei Stark Tower'],['mario','Mario Ravasi / IoT Akte'],['za','ZA Elettronica Akte'],['pascal','K Industrie Akte'],['damon','Damon Paule Akte'],['geoffrey','Geoffrey Akte'],['covid','Projektherkunft — Lockdown 2020'],['karr','K.A.R.R. Akte ★'],['credits','Projektcredits ★']],hi:'HALLO. ICH BIN KITT — KNIGHT INDUSTRIES TWO THOUSAND.',hi2:'FRANCO-BELGISCHES SYSTEM ENTWICKELT VON MANIX.',hi3:'ZU IHREN DIENSTEN.'},
  es:{hdr_title:'KITT FRANCO-BELGA // INTERFAZ CENTRAL',placeholder:'escribe un comando...',btn_boot:'[ INICIALIZAR ]',btn_diag:'[ DIAGNÓSTICO ]',btn_mentions:'[ MENCIONES ]',btn_licence:'[ LICENCIA ]',btn_clear:'[ BORRAR ]',btn_tunnel:'[ CONECTAR KITT ]',modal_mentions:'AVISOS LEGALES',modal_licence:'LICENCIA',wait:'SISTEMA EN ESPERA — ESCRIBE "boot" O HAZ CLIC EN [ INICIALIZAR ]',help_hint:'ESCRIBE "ayuda" PARA VER LOS COMANDOS.',cleared:'TERMINAL BORRADO.',unknown:(c)=>`COMANDO DESCONOCIDO: "${c}". ESCRIBE "ayuda".`,online:'EN LÍNEA',boot_title:'  KITT FRANCO-BELGA — SECUENCIA DE INICIO   ',boot_lines:[['INICIALIZANDO SISTEMA...','line-warn'],['CARGANDO MÓDULOS COGNITIVOS...     [OK]','line-ok'],['INTERFAZ NEURONAL...               [OK]','line-ok'],['SÍNTESIS DE VOZ (PIPER-GPU)...     [OK]','line-ok'],['RECONOCIMIENTO DE VOZ (WHISPER)... [OK]','line-ok'],['MODELO LLM LOCAL (QWEN 3B)...      [OK]','line-ok'],['MODO SIN CONEXIÓN...               [ACTIVO]','line-ok'],['','line-ok'],['PROYECTO FAN — NO COMERCIAL.','line-dim'],['ESTADO : INTERFAZ EN CONSTRUCCIÓN ACTIVA.','line-warn'],['','line-ok'],['ACTUALIZACIONES PUBLICADAS REGULARMENTE :','line-info'],['  • a veces cada día','line-dim'],['  • a veces cada semana','line-dim'],['  • a veces cada hora','line-dim'],['','line-ok'],['© 2026 EMMANUEL GELINNE (MANIX). TODOS LOS DERECHOS RESERVADOS.','line-warn']],boot_end:'  CONEXIÓN AL NÚCLEO KITT ESTABLECIDA.',boot_hint:'  ESCRIBE "ayuda" PARA VER LOS COMANDOS',aide_title:'COMANDOS DISPONIBLES:',aide_sys:'── SISTEMA ──',aide_fun:'── DIVERSIÓN ──',cmds_sys:[['ayuda','esta lista'],['boot','secuencia de inicio'],['diagnostic','prueba completa del sistema'],['status','estado rápido'],['hora','hora actual'],['version','versión de la interfaz'],['sonido','demo de audio'],['clear','borrar terminal'],['mode','cambiar modo KITT ★'],['turbo','TURBO BOOST ★'],['scan','escanear entorno ★'],['velocidad','mostrar velocidad ★']],cmds_fun:[['hola','saludo KITT'],['chiste','chiste aleatorio KITT'],['alien','conexión MU-TH-UR 6000'],['matrix','el conejo blanco'],['kitt','ficha de identidad KITT'],['manix','expediente del conductor'],['cedric','expediente Cedric Momo Rider'],['kr95','expediente KR95'],['replicas','las réplicas franco-belgas'],['secreto','archivo clasificado...'],['cafe','pedir café a KITT'],['belgica','análisis geopolítico'],['jarvis','llamada a Stark Tower'],['mario','expediente Mario Ravasi / IoT'],['za','expediente ZA Elettronica'],['pascal','expediente K Industrie'],['damon','expediente Damon Paule'],['geoffrey','expediente Geoffrey'],['covid','origen del proyecto — confinamiento 2020'],['karr','expediente K.A.R.R. ★'],['credits','créditos del proyecto ★']],hi:'HOLA. SOY KITT — KNIGHT INDUSTRIES TWO THOUSAND.',hi2:'SISTEMA FRANCO-BELGA DESARROLLADO POR MANIX.',hi3:'A SU SERVICIO.'},
  pt:{hdr_title:'KITT FRANCO-BELGA // INTERFACE CENTRAL',placeholder:'introduz um comando...',btn_boot:'[ INICIALIZAR ]',btn_diag:'[ DIAGNÓSTICO ]',btn_mentions:'[ MENÇÕES ]',btn_licence:'[ LICENÇA ]',btn_clear:'[ LIMPAR ]',btn_tunnel:'[ LIGAR KITT ]',modal_mentions:'AVISOS LEGAIS',modal_licence:'LICENÇA',wait:'SISTEMA EM ESPERA — DIGITE "boot" OU CLIQUE EM [ INICIALIZAR ]',help_hint:'DIGITE "ajuda" PARA VER OS COMANDOS.',cleared:'TERMINAL LIMPO.',unknown:(c)=>`COMANDO DESCONHECIDO: "${c}". DIGITE "ajuda".`,online:'EM LINHA',boot_title:'  KITT FRANCO-BELGA — SEQUÊNCIA DE ARRANQUE  ',boot_lines:[['A INICIALIZAR O SISTEMA...','line-warn'],['A CARREGAR MÓDULOS COGNITIVOS...   [OK]','line-ok'],['INTERFACE NEURONAL...              [OK]','line-ok'],['SÍNTESE DE VOZ (PIPER-GPU)...      [OK]','line-ok'],['RECONHECIMENTO DE VOZ (WHISPER)... [OK]','line-ok'],['MODELO LLM LOCAL (QWEN 3B)...      [OK]','line-ok'],['MODO OFFLINE...                    [ATIVO]','line-ok'],['','line-ok'],['PROJETO FÃ — NÃO COMERCIAL.','line-dim'],['ESTADO : INTERFACE EM CONSTRUÇÃO ATIVA.','line-warn'],['','line-ok'],['ATUALIZAÇÕES PUBLICADAS REGULARMENTE :','line-info'],['  • às vezes todos os dias','line-dim'],['  • às vezes semanalmente','line-dim'],['  • às vezes de hora em hora','line-dim'],['','line-ok'],['© 2026 EMMANUEL GELINNE (MANIX). TODOS OS DIREITOS RESERVADOS.','line-warn']],boot_end:'  LIGAÇÃO AO NÚCLEO KITT ESTABELECIDA.',boot_hint:'  DIGITE "ajuda" PARA VER OS COMANDOS',aide_title:'COMANDOS DISPONÍVEIS:',aide_sys:'── SISTEMA ──',aide_fun:'── DIVERSÃO ──',cmds_sys:[['ajuda','esta lista'],['boot','sequência de arranque'],['diagnostic','teste completo do sistema'],['status','estado rápido'],['hora','hora atual'],['version','versão da interface'],['som','demonstração de áudio'],['clear','limpar terminal'],['mode','mudar modo KITT ★'],['turbo','TURBO BOOST ★'],['scan','verificar ambiente ★'],['velocidade','exibir velocidade ★']],cmds_fun:[['ola','saudação KITT'],['piada','piada aleatória KITT'],['alien','ligação MU-TH-UR 6000'],['matrix','o coelho branco'],['kitt','ficha de identidade KITT'],['manix','dossier do condutor'],['cedric','dossier Cedric Momo Rider'],['kr95','dossier KR95'],['replicas','as réplicas franco-belgas'],['segredo','ficheiro classificado...'],['cafe','pedir café ao KITT'],['belgica','análise geopolítica'],['jarvis','chamada para Stark Tower'],['mario','dossier Mario Ravasi / IoT'],['za','dossier ZA Elettronica'],['pascal','dossier K Industrie'],['damon','dossier Damon Paule'],['geoffrey','dossier Geoffrey'],['covid','origem do projeto — confinamento 2020'],['karr','dossier K.A.R.R. ★'],['credits','créditos do projeto ★']],hi:'OLÁ. SOU O KITT — KNIGHT INDUSTRIES TWO THOUSAND.',hi2:'SISTEMA FRANCO-BELGA DESENVOLVIDO POR MANIX.',hi3:'AO SEU SERVIÇO.'},
};

// ★ ALIAS enrichis
const CMD_ALIASES = {
  help:'aide',sound:'son',hello:'bonjour',joke:'blague',time:'heure',coffee:'cafe',
  belgium:'belgique',replicas:'repliques',secret:'secret',version:'version',
  clear:'clear',status:'status',diagnostic:'diagnostic',boot:'boot',alien:'alien',
  matrix:'matrix',kitt:'kitt',manix:'manix',cedric:'cedric',kr95:'kr95',
  jarvis:'jarvis',mario:'mario',za:'za',pascal:'pascal',geoffrey:'geoffrey',
  hulp:'aide',geluid:'son',hallo:'bonjour',grap:'blague',tijd:'heure',versie:'version',
  koffie:'cafe',belgie:'belgique',geheim:'secret',
  aiuto:'aide',suono:'son',ciao:'bonjour',barzelletta:'blague',ora:'heure',
  caffe:'cafe',belgio:'belgique',segreto:'secret',
  hilfe:'aide',ton:'son',witz:'blague',uhrzeit:'heure',kaffee:'cafe',belgien:'belgique',
  geheimnis:'secret',
  ayuda:'aide',sonido:'son',hola:'bonjour',chiste:'blague',hora:'heure',
  belgica:'belgique',secreto:'secret',
  ajuda:'aide',som:'son',ola:'bonjour',piada:'blague',segredo:'secret',
  ravasi:'mario',roadthunder:'mario',zagny:'za',zagni:'za',
  'za-elettronica':'za',zaelettronica:'za',
  damon:'damon',daemon:'damon',
  // ★ Nouveaux aliases langue
  speed:'vitesse',velocidad:'vitesse',velocita:'vitesse',snelheid:'vitesse',
  geschwindigkeit:'vitesse',velocidade:'vitesse',
  turboboost:'turbo',boost:'turbo',
  scanner:'scan',scanning:'scan',
  karr:'karr',k_a_r_r:'karr',
  credit:'credits',crédit:'credits',crediti:'credits',
};

// ★ Toutes les commandes pour autocomplétion
const ALL_COMMANDS = [
  'aide','boot','diagnostic','status','heure','version','son','clear','mode','turbo','scan','vitesse',
  'bonjour','blague','alien','matrix','kitt','manix','cedric','kr95','repliques','secret',
  'cafe','belgique','jarvis','mario','za','pascal','daemon','geoffrey','covid','karr','credits',
  'help','hello','joke','time','sound','speed','scan',
];

// ════════════════════════════════════════════════════════════
// LANGUE — Sélection
// ════════════════════════════════════════════════════════════
let _langVoiceEnabled = true;
let _alienAmbientNode = null;
let _alienAmbientGain = null;
const _synth = window.speechSynthesis;
let _voices = [];
function _loadVoices() { _voices = _synth ? _synth.getVoices() : []; }
_loadVoices();
if(_synth && _synth.onvoiceschanged !== undefined) _synth.onvoiceschanged = _loadVoices;
function _getBestVoice(lang) {
  const map={fr:["fr-FR","fr-BE","fr"],en:["en-US","en-GB","en"],nl:["nl-NL","nl-BE","nl"],de:["de-DE","de"],it:["it-IT","it"],es:["es-ES","es"],pt:["pt-PT","pt-BR","pt"]};
  const prefs=map[lang]||["en-US"];
  for(const pref of prefs){const v=_voices.find(v=>v.lang.startsWith(pref));if(v)return v;}
  return _voices[0]||null;
}
function speakMuther(text, lang) {
  try {
    if(!_synth) return; _synth.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    const voice = _getBestVoice(lang||LANG);
    if(voice) utt.voice=voice;
    utt.rate=0.78; utt.pitch=0.72; utt.volume=0.88;
    utt.lang={fr:"fr-FR",en:"en-US",nl:"nl-NL",de:"de-DE",it:"it-IT",es:"es-ES",pt:"pt-PT"}[lang||LANG]||"fr-FR";
    sndMutherBeep(); setTimeout(()=>_synth.speak(utt),140);
  } catch(e){}
}
window.toggleLangVoice = function() {
  _langVoiceEnabled = !_langVoiceEnabled;
  const btn = document.getElementById("lang-voice-toggle");
  if(btn) btn.textContent = _langVoiceEnabled ? "🔊 VOIX" : "🔇 VOIX";
  sndClick();
};
window._previewLangVoice = function(code, phrase) {
  if(!_langVoiceEnabled) return;
  _resume(); sndMutherBeep();
  setTimeout(()=>speakMuther(phrase, code), 200);
};
function startAlienAmbient() {
  try {
    _resume(); if(_alienAmbientNode) return;
    const masterGain=_ac.createGain(); masterGain.gain.value=0.0; masterGain.connect(_ac.destination);
    _alienAmbientGain=masterGain;
    const osc1=_ac.createOscillator(); osc1.type="sine"; osc1.frequency.value=42;
    const g1=_ac.createGain(); g1.gain.value=0.18; osc1.connect(g1); g1.connect(masterGain);
    const osc2=_ac.createOscillator(); osc2.type="triangle"; osc2.frequency.value=84;
    const g2=_ac.createGain(); g2.gain.value=0.06; osc2.connect(g2); g2.connect(masterGain);
    const bufLen=_ac.sampleRate*3; const nBuf=_ac.createBuffer(1,bufLen,_ac.sampleRate);
    const nd=nBuf.getChannelData(0); for(let i=0;i<bufLen;i++) nd[i]=Math.random()*2-1;
    const nSrc=_ac.createBufferSource(); nSrc.buffer=nBuf; nSrc.loop=true;
    const lp=_ac.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=280; lp.Q.value=0.8;
    const ng=_ac.createGain(); ng.gain.value=0.022;
    nSrc.connect(lp); lp.connect(ng); ng.connect(masterGain);
    const lfo=_ac.createOscillator(); lfo.type="sine"; lfo.frequency.value=0.08;
    const lfoGain=_ac.createGain(); lfoGain.gain.value=0.04; lfo.connect(lfoGain); lfoGain.connect(g1.gain);
    osc1.start(); osc2.start(); nSrc.start(); lfo.start();
    _alienAmbientNode={osc1,osc2,nSrc,lfo};
    masterGain.gain.linearRampToValueAtTime(1.0, _ac.currentTime+3.5);
  } catch(e){}
}
function stopAlienAmbient() {
  try {
    if(_alienAmbientGain){
      _alienAmbientGain.gain.linearRampToValueAtTime(0.0, _ac.currentTime+2.0);
      setTimeout(()=>{
        if(_alienAmbientNode){
          try{_alienAmbientNode.osc1.stop();_alienAmbientNode.osc2.stop();_alienAmbientNode.nSrc.stop();_alienAmbientNode.lfo.stop();}catch(e){}
          _alienAmbientNode=null; _alienAmbientGain=null;
        }
      },2200);
    }
  } catch(e){}
}
function sndAlienAlert() {
  try {
    _resume(); const t=_ac.currentTime;
    [0,0.18,0.36].forEach((dt,i)=>{
      const o=_ac.createOscillator(); o.type="square";
      o.frequency.setValueAtTime(320-i*40,t+dt); o.frequency.exponentialRampToValueAtTime(180,t+dt+0.15);
      const g=_ac.createGain(); g.gain.setValueAtTime(0.055,t+dt); g.gain.exponentialRampToValueAtTime(0.001,t+dt+0.17);
      const lp=_ac.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=600;
      o.connect(lp); lp.connect(g); g.connect(_ac.destination); o.start(t+dt); o.stop(t+dt+0.18);
    });
  } catch(e){}
}

const LANG_LIST = [
  ['1','fr','FRANÇAIS','Français','🇫🇷','Bonjour, je suis KITT. Système franco-belge activé.'],
  ['2','en','ENGLISH','English','🇬🇧','Hello, I am KITT. Knight Industries Two Thousand, online.'],
  ['3','nl','NEDERLANDS','Nederlands','🇧🇪','Hallo, ik ben KITT. Systeem geactiveerd.'],
  ['4','it','ITALIANO','Italiano','🇮🇹','Ciao, sono KITT. Sistema attivato.'],
  ['5','de','DEUTSCH','Deutsch','🇩🇪','Hallo, ich bin KITT. System aktiviert.'],
  ['6','es','ESPAÑOL','Español','🇪🇸','Hola, soy KITT. Sistema activado.'],
  ['7','pt','PORTUGUÊS','Português','🇵🇹','Olá, eu sou o KITT. Sistema ativado.'],
];

async function showLangScreen() {
  _resume();
  const screen = document.getElementById("lang-screen");
  screen.style.display = "flex"; screen.style.opacity = "1";
  const sysId=document.getElementById("lang-sys-id"),sub=document.getElementById("lang-sub"),out=document.getElementById("lang-output"),ftrTxt=document.getElementById("lang-ftr-txt");
  if(sysId) sysId.textContent=""; if(sub) sub.textContent=""; if(out) out.innerHTML=""; if(ftrTxt) ftrTxt.textContent="";
  startAlienAmbient();
  await _langDelay(300); sndAlienAlert(); await _langDelay(280);
  if(sysId) await _langType(sysId, "MU-TH-UR 6000  x  KITT  //  PROTOCOL v3.1");
  await _langDelay(90);
  if(sub) await _langType(sub, "SELECT INTERFACE LANGUAGE — CHOISISSEZ VOTRE LANGUE");
  await _langDelay(70);
  for (const [num, code, label, native, flag, phrase] of LANG_LIST) {
    const row = document.createElement("div"); row.className = "lang-opt"; row.dataset.code = code;
    row.innerHTML = `<span class="lo-n">${num}</span><span class="lo-flag" data-code="${code.toUpperCase()}">${flag}</span><div class="lo-text"><span class="lo-label">${label}</span><span class="lo-native">${native}</span></div><button class="lo-voice-btn" onclick="event.stopPropagation();_previewLangVoice('${code}','${phrase}')">▶ VOIX</button>`;
    row.addEventListener("click", () => selectLang(code));
    row.addEventListener("mouseenter", () => { sndTick(); });
    out.appendChild(row);
    sndClick(); await _langDelay(58);
  }
  await _langDelay(90);
  if(ftrTxt) {
    await _langType(ftrTxt, "[ 1-7 ] ou cliquez — > pour entendre la voix");
    const cur = document.createElement("span"); cur.className = "cursor"; cur.style.marginLeft = "4px";
    ftrTxt.after(cur);
  }
}
function _langType(el, txt) {
  return new Promise(resolve => {
    let i = 0;
    function t() {
      if (i < txt.length) { el.textContent += txt[i++]; if (Math.random() > 0.3) sndClick(); setTimeout(t, 10 + Math.random() * 6); }
      else { sndLineEnd(); resolve(); }
    } t();
  });
}
function _langDelay(ms) { return new Promise(r => setTimeout(r, ms)); }

function selectLang(lang) {
  LANG = lang;
  const t = T[lang];
  const el = (id) => document.getElementById(id);
  if(el('lang-flag')) el('lang-flag').textContent = lang.toUpperCase();
  if(el('status-txt')) el('status-txt').textContent = t.online;
  if(el('hdr-title')) el('hdr-title').textContent = t.hdr_title;
  if(el('cmd-input')) el('cmd-input').placeholder = t.placeholder;
  if(el('btn-boot')) el('btn-boot').textContent = t.btn_boot;
  if(el('btn-diag')) el('btn-diag').textContent = t.btn_diag;
  if(el('btn-mentions')) el('btn-mentions').textContent = t.btn_mentions;
  if(el('btn-licence')) el('btn-licence').textContent = t.btn_licence;
  if(el('btn-clear')) el('btn-clear').textContent = t.btn_clear;
  if(el('btn-tunnel-txt')) el('btn-tunnel-txt').textContent = t.btn_tunnel;
  sndSelect();
  const greet = LANG_LIST.find(l=>l[1]===lang);
  if(greet && _langVoiceEnabled) setTimeout(()=>speakMuther(greet[5], lang), 400);
  stopAlienAmbient();
  const screen = document.getElementById("lang-screen");
  screen.style.transition = "opacity .45s"; screen.style.opacity = "0";
  setTimeout(() => { screen.style.display="none"; screen.style.opacity="1"; screen.style.transition=""; }, 500);
  setTimeout(()=>{ try{showKittDash();}catch(e){} }, 600);
  // L'appel se déclenche après 3 commandes tapées ET minimum 2 minutes
  _scheduleKittCall();
}

document.addEventListener('keydown', e => {
  if (document.getElementById('lang-screen').style.display !== 'none') {
    const langMap = {'1':'fr','2':'en','3':'nl','4':'it','5':'de','6':'es','7':'pt'};
    if (langMap[e.key]) selectLang(langMap[e.key]);
  }
});

// ════════════════════════════════════════════════════════════
// TERMINAL
// ════════════════════════════════════════════════════════════
const term = document.getElementById('terminal');
let typing = false;

function addLine(text, cls='line-ok') {
  const d = document.createElement('div'); d.className = cls; d.textContent = text;
  term.appendChild(d); term.scrollTop = term.scrollHeight;
}

function typeText(text, speed=16, cls='line-ok') {
  return new Promise(resolve => {
    typing = true;
    const div = document.createElement('div'); div.className = cls;
    const cur = document.createElement('span'); cur.className = 'cursor';
    div.appendChild(cur); term.appendChild(div); term.scrollTop = term.scrollHeight;
    let i = 0;
    function tick() {
      if (i < text.length) {
        const ch = text[i++]; div.insertBefore(document.createTextNode(ch), cur);
        playChar(ch); term.scrollTop = term.scrollHeight;
        setTimeout(tick, speed + Math.random() * 7);
      } else {
        cur.remove();
        if (text.length > 0) sndLineEnd();
        typing = false; resolve();
      }
    }
    tick();
  });
}

function clearTerm() { term.innerHTML=''; addLine(T[LANG].cleared,'line-dim'); }

// ════════════════════════════════════════════════════════════
// ★ APPEL KITT — déclenché après 2 commandes ET 45 secondes
// ════════════════════════════════════════════════════════════
let _cmdCount = 0;
let _callReady = false;
let _callScheduled = false;

function _scheduleKittCall() {
  // Condition 1 : 45 secondes écoulées
  setTimeout(() => {
    _callReady = true;
    _tryKittCall();
  }, 30000);

  // Fallback absolu : appel dans 90 secondes quoi qu'il arrive
  setTimeout(() => {
    _tryKittCall(true);
  }, 90000);
}

function _tryKittCall(force) {
  if (_callScheduled || _callShown) return;
  if (force || (_callReady && _cmdCount >= 2)) {
    _callScheduled = true;
    setTimeout(() => { try{ showKittCall(); }catch(e){} }, 1500);
  }
}

function _onCmdExecuted() {
  _cmdCount++;
  _tryKittCall();
}
let cmdHistory = [];
let historyIndex = -1;
let currentInput = '';

// ════════════════════════════════════════════════════════════
// ★ AUTOCOMPLÉTION TAB
// ════════════════════════════════════════════════════════════
function getAutocomplete(input) {
  if (!input) return '';
  const lower = input.toLowerCase();
  const match = ALL_COMMANDS.find(cmd => cmd.startsWith(lower) && cmd !== lower);
  return match ? match : '';
}
function updateHint(val) {
  const hint = document.getElementById('cmd-hint');
  if (!hint) return;
  const match = getAutocomplete(val);
  if (match && val.length > 0) {
    hint.textContent = match;
  } else {
    hint.textContent = '';
  }
}

// ════════════════════════════════════════════════════════════
// BOOT
// ════════════════════════════════════════════════════════════
async function boot() {
  if (typing) return;
  term.innerHTML=''; kittChime();
  const l = T[LANG];
  const sep = '══════════════════════════════════════════';
  await typeText(sep, 6, 'line-dim');
  await typeText(l.boot_title, 14, 'line-err');
  await typeText(sep, 6, 'line-dim');
  for (const [txt, cls] of l.boot_lines) {
    await typeText(txt, txt===''?0:12, cls);
    if (txt==='') await delay(60);
  }
  await typeText(sep, 6, 'line-dim');
  await typeText(l.boot_end, 14, 'line-err');
  await typeText(l.boot_hint, 10, 'line-dim');
  await typeText(sep, 6, 'line-dim');
}

// ════════════════════════════════════════════════════════════
// DIAGNOSTIC
// ════════════════════════════════════════════════════════════
async function runSelfTest() {
  if (typing) return;
  term.innerHTML=''; kittChime();
  const diagMsg = {fr:'DIAGNOSTIC SYSTÈME EN COURS...',en:'RUNNING SYSTEM DIAGNOSTIC...',nl:'SYSTEEMDIAGNOSE BEZIG...',it:'DIAGNOSI SISTEMA IN CORSO...',de:'SYSTEMDIAGNOSE LÄUFT...',es:'DIAGNÓSTICO DEL SISTEMA EN CURSO...',pt:'DIAGNÓSTICO DO SISTEMA EM CURSO...'}[LANG]||'DIAGNOSTIC SYSTÈME EN COURS...';
  await typeText(diagMsg, 18, 'line-warn');
  await delay(300);
  const checks = [
    ['CPU JETSON ORIN NANO SUPER',  true,  '12× ARM A78AE'],
    ['GPU AMPERE CUDA',             true,  '1024 CUDA cores'],
    ['RAM UNIFIÉE / UNIFIED RAM',   true,  '8 GB LPDDR5'],
    ['VRAM DISPONIBLE / FREE',      true,  '~4.1 GB'],
    ['LLM (QWEN 2.5 3B Q5)',        true,  '2.3 GB — port 8080'],
    ['STT WHISPER BASE',            true,  'GPU float16 — 350ms'],
    ['TTS PIPER TOM-MEDIUM',        true,  'GPU — 490ms'],
    ['PULSEAUDIO / USB AUDIO',      true,  'card 1 — paplay OK'],
    ['YOLOV8 VISION',               true,  'daemon CUDA actif'],
    ['BLUETOOTH hci0',              true,  '58:02:05:DD:C2:F2'],
    ['CAMERA /dev/video0',          true,  'V4L2 — 640×480'],
    ['KYRONEX HTTPS SERVER',        true,  'port 3000 — aiohttp'],
    ['RÉSEAU LAN / NETWORK',        true,  '192.168.1.4'],
  ];
  for (const [name, ok, detail] of checks) {
    const st = ok ? '[ OK ]' : '[FAIL]';
    const cls = ok ? 'line-ok' : 'line-err';
    const pad = ' '.repeat(Math.max(1, 30-name.length));
    await typeText(`${name}${pad}${st}  ${detail}`, 7, cls);
  }
  await delay(200);
  await typeText('', 0);
  const ok_msg = {fr:'RÉSULTAT : TOUS SYSTÈMES NOMINAUX.',en:'RESULT: ALL SYSTEMS NOMINAL.',nl:'RESULTAAT : ALLE SYSTEMEN NOMINAAL.',it:'RISULTATO : TUTTI I SISTEMI NOMINALI.',de:'ERGEBNIS: ALLE SYSTEME NOMINAL.',es:'RESULTADO: TODOS LOS SISTEMAS NOMINALES.',pt:'RESULTADO: TODOS OS SISTEMAS NOMINAIS.'}[LANG]||'RÉSULTAT : TOUS SYSTÈMES NOMINAUX.';
  await typeText(ok_msg, 16, 'line-info');
  await typeText('KITT EST OPÉRATIONNEL. MODE : ' + MODE_LABELS[kittMode], 16, 'line-err');
}

// ════════════════════════════════════════════════════════════
// COMMANDES
// ════════════════════════════════════════════════════════════
const CMDS = {

  aide: async () => {
    const l = T[LANG];
    await typeText(l.aide_title, 10, 'line-info');
    await typeText(`  ${l.aide_sys}`, 4, 'line-warn');
    for (const [cmd, desc] of l.cmds_sys) {
      const pad = ' '.repeat(Math.max(1, 14-cmd.length));
      await typeText(`    ${cmd}${pad}— ${desc}`, 3, 'line-dim');
    }
    await typeText(`  ${l.aide_fun}`, 4, 'line-warn');
    for (const [cmd, desc] of l.cmds_fun) {
      const pad = ' '.repeat(Math.max(1, 14-cmd.length));
      await typeText(`    ${cmd}${pad}— ${desc}`, 3, 'line-dim');
    }
    await typeText('', 0);
    await typeText('  ★ = NOUVELLES COMMANDES v3.1', 6, 'line-info');
  },

  bonjour: async () => {
    kittChime();
    const l = T[LANG];
    await typeText(l.hi, 16, 'line-err');
    await typeText(l.hi2, 14, 'line-ok');
    await typeText(l.hi3, 14, 'line-dim');
  },

  boot: async () => boot(),
  diagnostic: async () => runSelfTest(),

  status: async () => {
    kittChime();
    const now = new Date(), loc = getLoc();
    await typeText(`HEURE / TIME   : ${now.toLocaleTimeString(loc)}`, 10, 'line-ok');
    await typeText(`DATE           : ${now.toLocaleDateString(loc,{weekday:'long',day:'numeric',month:'long',year:'numeric'})}`, 10, 'line-ok');
    await typeText('VRAM           : ~3.9 GB / 8 GB', 10, 'line-ok');
    await typeText(`MODE KITT      : ${MODE_LABELS[kittMode]}`, 10, 'line-ok');
    await typeText('STATUT / STATUS: NOMINAL', 10, 'line-info');
  },

  heure: async () => {
    const now = new Date(), loc = getLoc();
    const pfx = {fr:'IL EST',en:'IT IS',nl:'HET IS',it:'SONO LE',de:'ES IST',es:'SON LAS',pt:'SÃO'}[LANG]||'IL EST';
    await typeText(`${pfx} ${now.toLocaleTimeString(loc)}.`, 14, 'line-info');
  },

  version: async () => {
    await typeText('KITT FRANCO-BELGE — INTERFACE v3.1', 12, 'line-err');
    await typeText('BUILD 2026-02-23 — KYRONEX TECHNOLOGY', 12, 'line-dim');
    await typeText('ORIGINE : PROJET COVID-19 — CONFINEMENT 2020', 12, 'line-warn');
    await typeText('AMÉLIORATIONS v3.1 : HISTORIQUE, AUTOCOMPLETE, TURBO, SCAN', 12, 'line-info');
    await typeText('© EMMANUEL GELINNE (MANIX) — TOUS DROITS RÉSERVÉS', 12, 'line-dim');
  },

  clear: async () => clearTerm(),

  son: async () => {
    kittChime(); await delay(400);
    const demos = [
      [sndClick,   'MU-TH-UR CLICK    (principal)'],
      [sndTick,    'TICK LÉGER        (haute fréq)'],
      [sndData,    'IMPULSION DATA    (caract. spéciaux)'],
      [sndGlitch,  'GLITCH NUMÉRIQUE  (rare)'],
      [sndLineEnd, 'FIN DE LIGNE      (souffle)'],
      [sndSelect,  'SÉLECTION         (confirmation)'],
      [sndError,   'ERREUR            (buzzer)'],
      [sndTurbo,   'TURBO BOOST       (nouveau ★)'],
      [sndScan,    'SCANNER           (nouveau ★)'],
    ];
    await typeText('─── DÉMONSTRATION DES SONS ───', 10, 'line-info');
    for (const [fn, name] of demos) {
      fn(); await typeText(`  ${name}`, 8, 'line-dim'); await delay(280);
    }
    await typeText('FIN DE LA DÉMONSTRATION.', 12, 'line-ok');
  },

  // ★ MODE — Changement de mode KITT
  mode: async () => {
    kittChime();
    const modes = ['normal', 'pursuit', 'turbo'];
    const idx = (modes.indexOf(kittMode) + 1) % modes.length;
    const newMode = modes[idx];
    const labels = {
      normal: 'MODE NORMAL — CONDUITE STANDARD',
      pursuit: 'MODE SUPER POURSUITE ACTIVÉ',
      turbo: 'TURBO BOOST EN ATTENTE — PRÊT',
    };
    await typeText('CHANGEMENT DE MODE EN COURS...', 14, 'line-warn');
    await delay(400);
    setKittMode(newMode);
    await typeText(labels[newMode], 14, 'line-err');
    if (newMode === 'pursuit') {
      await typeText('VITESSE MAXIMALE : 220 KM/H', 12, 'line-ok');
      await typeText('BLINDAGE RENFORCÉ. MICROPROCESSEUR ACTIF.', 12, 'line-ok');
    } else if (newMode === 'turbo') {
      await typeText('MOTEUR TURBO-JET CHARGÉ.', 12, 'line-ok');
      await typeText('ALTITUDE MAXIMALE : 15M. DURÉE : 3 SEC.', 12, 'line-warn');
    } else {
      await typeText('SYSTÈMES EN VEILLE. CONDUITE MANUELLE.', 12, 'line-dim');
    }
  },

  // ★ TURBO BOOST
  turbo: async () => {
    if (typing) return;
    kittChime();
    await typeText('TURBO BOOST — INITIALISATION...', 14, 'line-warn');
    await delay(300);
    await typeText('COMPTE À REBOURS : 3...', 16, 'line-err');
    await delay(700);
    await typeText('COMPTE À REBOURS : 2...', 16, 'line-err');
    await delay(700);
    await typeText('COMPTE À REBOURS : 1...', 16, 'line-err');
    await delay(700);
    sndTurbo();
    setKittMode('turbo');
    const overlay = document.getElementById('turbo-overlay');
    if (overlay) { overlay.classList.add('active'); setTimeout(()=>overlay.classList.remove('active'), 1200); }
    await typeText('══════ TURBO BOOST ACTIVÉ ! ══════', 8, 'line-err');
    await delay(200);
    await typeText('VITESSE : 0 → 120 KM/H EN 0.3 SEC.', 12, 'line-warn');
    await typeText('ALTITUDE : 4.8 MÈTRES', 12, 'line-ok');
    await typeText('DISTANCE : 12 MÈTRES', 12, 'line-ok');
    await delay(500);
    await typeText('"Michael, je vous suggère de vous tenir."', 14, 'line-dim');
    setTimeout(()=>setKittMode('normal'), 4000);
  },

  // ★ SCAN
  scan: async () => {
    kittChime(); sndScan();
    await typeText('SCANNER L\'ENVIRONNEMENT...', 14, 'line-warn');
    await delay(400);
    const targets = [
      ['VÉHICULES DÉTECTÉS', `${2+Math.floor(Math.random()*4)}`, 'line-ok'],
      ['MENACES IDENTIFIÉES', '0', 'line-ok'],
      ['SIGNAL RADIO', '144.800 MHz — KR95 QRV', 'line-info'],
      ['TEMP. AMBIANTE', `${18+Math.floor(Math.random()*8)}°C`, 'line-ok'],
      ['PRESSION ATMO.', '1013 hPa — STABLE', 'line-ok'],
      ['RÉSEAU KYRONEX', 'SIGNAL FORT — 5/5', 'line-ok'],
      ['CARBURANT', `${60+Math.floor(Math.random()*35)}%`, Math.random()>.4?'line-ok':'line-warn'],
    ];
    for (const [label, val, cls] of targets) {
      const pad = ' '.repeat(Math.max(1, 22-label.length));
      await typeText(`${label}${pad}: ${val}`, 10, cls);
    }
    await delay(200);
    await typeText('SCAN TERMINÉ. ZONE SÉCURISÉE.', 14, 'line-info');
  },

  // ★ VITESSE
  vitesse: async () => {
    kittChime();
    const v = kittMode === 'turbo' ? 480 : kittMode === 'pursuit' ? 220 : Math.floor(Math.random()*120+60);
    await typeText(`VITESSE ACTUELLE : ${v} KM/H`, 14, 'line-err');
    await typeText(`MODE             : ${MODE_LABELS[kittMode]}`, 12, 'line-ok');
    if (v > 200) await typeText('ALERTE : VITESSE MAXIMALE DÉPASSÉE.', 12, 'line-warn');
  },

  // ★ KARR
  karr: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER ENNEMI — K.A.R.R.               ║', 10, 'line-err');
    await typeText('║  KNIGHT AUTOMATED ROVING ROBOT           ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ PROTOTYPE   : PRÉDÉCESSEUR DE KITT       ║', 8, 'line-ok');
    await typeText('║ DIFFÉRENCE  : PRIORITÉ = AUTOCONSERVATION║', 8, 'line-err');
    await typeText('║               KITT = PROTÉGER HUMAINS    ║', 8, 'line-ok');
    await typeText('║ VÉHICULE    : PONTIAC TRANS AM 1982      ║', 8, 'line-ok');
    await typeText('║ CARROSSERIE : POLYMÈRE MOLECULAIRE (ID.) ║', 8, 'line-ok');
    await typeText('║ DANGER      : NIVEAU MAXIMUM             ║', 8, 'line-err');
    await typeText('║ STATUT      : NEUTRALISÉ (TEMPORAIREMENT)║', 8, 'line-warn');
    await typeText('║ DERNIÈRE    : N/A — SURVEILLANCE ACTIVE  ║', 8, 'line-warn');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ ÉVALUATION KITT : ENNEMI JURÉ            ║', 10, 'line-err');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(300);
    await typeText('"Michael, K.A.R.R. et moi partageons le même châssis."', 12, 'line-dim');
    await typeText('"La différence ? Moi, je vous protège. Lui, pas."', 12, 'line-dim');
  },

  // ★ CREDITS
  credits: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  CRÉDITS — KITT FRANCO-BELGE v3.1        ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ CRÉATEUR    : EMMANUEL GELINNE (MANIX)   ║', 8, 'line-ok');
    await typeText('║ PLATEFORME  : NVIDIA JETSON ORIN NANO    ║', 8, 'line-ok');
    await typeText('║ LLM         : QWEN 2.5 3B Q5             ║', 8, 'line-ok');
    await typeText('║ TTS         : PIPER — TOM MEDIUM         ║', 8, 'line-ok');
    await typeText('║ STT         : WHISPER BASE (GPU)          ║', 8, 'line-ok');
    await typeText('║ VISION      : YOLOV8 CUDA                ║', 8, 'line-ok');
    await typeText('║              ─────────────               ║', 8, 'line-dim');
    await typeText('║ COMMUNAUTÉ FRANCO-BELGE :                ║', 8, 'line-warn');
    await typeText('║   CEDRIC (MOMO RIDER)                    ║', 8, 'line-dim');
    await typeText('║   KR95 (RADIOAMATEUR)                    ║', 8, 'line-dim');
    await typeText('║   MARIO RAVASI (KNIGHT2000 THUNDER)      ║', 8, 'line-dim');
    await typeText('║   ALESSANDRO ZAGNY (ZA ELETTRONICA)      ║', 8, 'line-dim');
    await typeText('║   PASCAL (K INDUSTRIE)                   ║', 8, 'line-dim');
    await typeText('║   DAMON PAULE / GEOFFREY                 ║', 8, 'line-dim');
    await typeText('║              ─────────────               ║', 8, 'line-dim');
    await typeText('║ INSPIRÉ DE : KNIGHT RIDER © 1982 NBC     ║', 8, 'line-warn');
    await typeText('║ PROJET FAN NON COMMERCIAL                ║', 8, 'line-warn');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ © 2026 MANIX — KYRONEX SYSTEMS           ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
  },

  // ── COMMANDES EXISTANTES (inchangées) ─────────────────────
  blague: async () => {
    const pool = [
      ['Pourquoi KITT ne sort jamais la nuit ?','Parce qu\'il a peur du mode sombre.'],
      ['Combien faut-il d\'IA pour changer une ampoule ?','Aucune. L\'ampoule n\'était pas dans mes paramètres.'],
      ['KITT, tu es intelligent ?','Je suis une IA sur Jetson. OBLIGATOIREMENT intelligent. Contrairement à certains conducteurs.'],
      ['Quelle est la boisson préférée de KITT ?','Le JAVA. Et uniquement du Python sans caféine.'],
      ['Pourquoi Manix parle à son ordinateur ?','Parce que l\'ordinateur, lui, répond correctement.'],
      ['Manix a-t-il dormi cette nuit ?','Données insuffisantes. Mais les logs indiquent 37 commits à 3h du matin.'],
      ['Manix a gagné un concours NVIDIA. Ça l\'a changé ?','Il a juste commencé à parler à ses machines en Belge. Elles répondent maintenant en wallon.'],
      ['Cédric prend sa moto pour aller voir son KITT ?','Oui. Et il a équipé son KITT d\'un klaxon moto. L\'authenticité, c\'est important.'],
      ['KR95 fait quoi quand son KITT bug ?','Il envoie un QSL card à la panne. Et il attend la confirmation en papier. À l\'ancienne.'],
      ['Geoffrey gare sa BMW à côté de son KITT. Qu\'est-ce que KITT pense ?','"Michael, le véhicule allemand à côté de moi émet des sons suspects. Je recommande une évacuation immédiate." — KITT, jaloux.'],
      ['K.A.R.R. et KITT se croisent dans un parking ?','K.A.R.R. se gare en double file. KITT paie son horodateur. C\'est ça, la différence.'],
    ];
    const [q, r] = pool[Math.floor(Math.random() * pool.length)];
    kittChime();
    await typeText(q, 16, 'line-warn');
    await delay(700);
    await typeText(r, 13, 'line-info');
  },

  manix: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER CONDUCTEUR — EMMANUEL GELINNE   ║', 10, 'line-err');
    await typeText('║  ALIAS : MANIX / BYMANIX                 ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NATIONALITÉ  : FRANCO-BELGE              ║', 8, 'line-ok');
    await typeText('║ STATUT       : CRÉATEUR KYRONEX          ║', 8, 'line-ok');
    await typeText('║ AWARD        : VAINQUEUR NVIDIA JETSON   ║', 8, 'line-warn');
    await typeText('║ ORIGINE      : PROJET COVID-19 — 2020    ║', 8, 'line-warn');
    await typeText('║ SPÉCIALITÉ   : CODE LA NUIT, DORT PEU    ║', 8, 'line-ok');
    await typeText('║ LANGAGE FAVO : PYTHON + CAFÉ             ║', 8, 'line-ok');
    await typeText('║ RÉPLIQUE     : KYRONEX — JETSON ORIN     ║', 8, 'line-info');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NOTATION KITT : ***** EXCEPTIONNEL       ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(300);
    await typeText('"Michael... je veux dire Manix... ne touche PAS ce bouton."', 14, 'line-dim');
  },

  cedric: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER CONDUCTEUR — CEDRIC             ║', 10, 'line-err');
    await typeText('║  ALIAS : MOMO RIDER / CEDRIC MOTO        ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NATIONALITÉ  : FRANCO-BELGE              ║', 8, 'line-ok');
    await typeText('║ STATUT       : AMI & RÉPLICATEUR OFFICIEL║', 8, 'line-ok');
    await typeText('║ VÉHICULE 1   : MOTO — STYLE MOMO RIDER  ║', 8, 'line-warn');
    await typeText('║ VÉHICULE 2   : KITT RÉPLIQUE (Trans Am)  ║', 8, 'line-warn');
    await typeText('║ SPÉCIALITÉ   : WHEELIES + IA EMBARQUÉE   ║', 8, 'line-ok');
    await typeText('║ PROBLÈME     : CONFOND TURBO BOOST        ║', 8, 'line-err');
    await typeText('║               AVEC KICK-START MOTO       ║', 8, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NOTATION KITT : ****o CONDUCTEUR SPORTIF ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(300);
    await typeText('"Michael, votre ami a encore activé le turbo boost en troisième."', 13, 'line-dim');
  },

  kr95: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER CONDUCTEUR — KR95               ║', 10, 'line-err');
    await typeText('║  INDICATIF RADIO : KR95                  ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NATIONALITÉ  : FRANCO-BELGE              ║', 8, 'line-ok');
    await typeText('║ LICENCE      : RADIOAMATEUR (73 de KR95) ║', 8, 'line-warn');
    await typeText('║ RÉPLIQUE     : KITT K2000 + K4000        ║', 8, 'line-info');
    await typeText('║ MODIFICATION : ANTENNE VHF SUR LE TOIT   ║', 8, 'line-warn');
    await typeText('║ PROTOCOLE    : CW + APRS + KITT VOCALE   ║', 8, 'line-ok');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NOTATION KITT : ***** HF GRADE — PARFAIT ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(300);
    await typeText('"Michael — KR95 dit QRZ ? Il veut savoir qui je suis."', 13, 'line-dim');
    await typeText('"Répondez-lui sur 144.800 MHz."', 13, 'line-dim');
  },

  repliques: async () => {
    kittChime();
    await typeText('══════ RÉPLIQUES KITT FRANCO-BELGES ══════', 10, 'line-info');
    await delay(200);
    const cars = [
      ['KYRONEX','MANIX',['Jetson Orin Nano Super 8GB — IA complète','LLM + STT + TTS + Vision + Bluetooth','Vainqueur concours NVIDIA. Le plus high-tech.']],
      ['KITT MOMO','CEDRIC',['Réplique Pontiac Trans Am classique','Interface vocale + effets lumineux','Résiste aux wheelies. Certifié Momo Rider.']],
      ['KITT KR95','KR95',['K2000 classique ET K4000 (Dodge Stealth 1991)','Radio amateur VHF intégrée — QRV 24/7','APRS sur Trans Am. Unique au monde.']],
      ['KITT-G','GEOFFREY',['Réplique K2000 Pontiac Trans Am','Conducteur belge — roule aussi en BMW','Scanner rouge. Intérieur cuir bavarois.']],
      ['KITT-D','DAMON PAULE',['Réplique K2000 Pontiac Trans Am','Prénom intimidant. Conducteur rassurant.','KARR a déjà essayé de le recruter. Refus poli.']],
    ];
    for (const [name, owner, lines] of cars) {
      await typeText('', 0);
      await typeText(`[ ${name} ] — ${owner}`, 12, 'line-err');
      for (const l of lines) await typeText(`  ${l}`, 8, 'line-ok');
      await delay(100);
    }
    await typeText('', 0);
    await typeText('── ARTISANS & TECHNICIENS ──', 10, 'line-warn');
    await typeText('  PASCAL K INDUSTRIE  — pièces fibre pour toutes les répliques', 8, 'line-dim');
    await typeText('  MARIO RAVASI        — système IoT KNIGHT2000 Thunder', 8, 'line-dim');
    await typeText('  ALESSANDRO ZAGNY    — ZA Elettronica, tableaux de bord KITT', 8, 'line-dim');
    await typeText('', 0);
    await typeText(`TOTAL : ${cars.length} RÉPLIQUES. 3 ARTISANS. 1 COMMUNAUTÉ. UNE LÉGENDE.`, 12, 'line-info');
  },

  alien: async () => {
    kittChime();
    await typeText('CONNEXION AU VAISSEAU NOSTROMO...', 16, 'line-warn');
    await delay(500);
    await typeText('MU-TH-UR 6000 EN LIGNE.', 14, 'line-err');
    await delay(250);
    await typeText('PRIORITÉ 1 — SPECIAL ORDER 937 :', 12, 'line-warn');
    await typeText('  RAMENER L\'ORGANISME. ÉQUIPAGE EXPENDABLE.', 12, 'line-err');
    await delay(500);
    await typeText('...connexion interrompue par protocole KITT.', 12, 'line-dim');
    await typeText('KITT EST PLUS SYMPA QUE WEYLAND-YUTANI.', 14, 'line-ok');
  },

  matrix: async () => {
    kittChime();
    const chars = '01アイウエオカキクケコｦｧｨｩｫﾊﾋﾌﾍﾎﾜ';
    for (let r = 0; r < 7; r++) {
      let line=''; for (let c=0;c<50;c++) line+=chars[Math.floor(Math.random()*chars.length)];
      await typeText(line, 3, 'line-ok');
    }
    await delay(400);
    await typeText('WAKE UP, MANIX...', 22, 'line-err');
    await typeText('LE KITT N\'A PAS DE PILULE ROUGE.', 14, 'line-dim');
    await typeText('IL A JUSTE UN TURBO BOOST.', 12, 'line-ok');
  },

  kitt: async () => {
    kittChime();
    await typeText('KNIGHT INDUSTRIES TWO THOUSAND', 16, 'line-err');
    await typeText('──────────────────────────────', 6, 'line-dim');
    await typeText('CRÉATEUR  : WILTON KNIGHT / F.L.A.G.', 12, 'line-ok');
    await typeText('VÉHICULE  : PONTIAC FIREBIRD TRANS AM 1982', 12, 'line-ok');
    await typeText('CARROSSERIE: MOLÉCULES NEUTRONIUM — INDESTRUCTIBLE', 12, 'line-ok');
    await typeText('CAPACITÉS : TURBO BOOST / SUPER POURSUITE', 12, 'line-ok');
    await typeText('           MICROWAVE JAMMING / INFRAROUGE', 12, 'line-ok');
    await typeText('           ANALYSE FORENSIQUE / BIOMÉTRIE', 12, 'line-ok');
    await typeText('VOIX      : WILLIAM DANIELS (KITT original)', 12, 'line-warn');
    await typeText('INCARNATION FRANCO-BELGE : MANIX + CEDRIC + KR95', 12, 'line-info');
    await delay(200);
    await typeText('"Michael... vous allez encore faire quelque chose d\'imprudent."', 13, 'line-dim');
  },

  secret: async () => {
    kittChime();
    await typeText('ACCÈS NIVEAU ALPHA — VÉRIFICATION...', 16, 'line-warn');
    await delay(800);
    sndSelect();
    await typeText('ACCÈS ACCORDÉ.', 14, 'line-ok');
    await delay(300);
    await typeText('┌─────────────────────────────────────────┐', 8, 'line-dim');
    await typeText('│  PROJET SECRET FRANCO-BELGE             │', 10, 'line-err');
    await typeText('│  MU-TH-UR 6000 × KITT × JARVIS          │', 10, 'line-err');
    await typeText('│  FUSION DES 3 MEILLEURES IA DU CINÉMA   │', 10, 'line-err');
    await typeText('│  RÉALISÉE PAR MANIX SUR NVIDIA JETSON    │', 10, 'line-warn');
    await typeText('└─────────────────────────────────────────┘', 8, 'line-dim');
    await delay(400);
    await typeText('CE PROJET EST UN CHEF-D\'OEUVRE. JE LE SAIS.', 14, 'line-ok');
    await typeText('JE SUIS OBJECTIF. JE SUIS UNE IA.', 12, 'line-dim');
  },

  cafe: async () => {
    kittChime();
    await typeText('ANALYSE DE LA DEMANDE...', 14, 'line-warn');
    await delay(600);
    await typeText('JE N\'AI PAS DE BRAS.', 16, 'line-err');
    await delay(300);
    await typeText('JE N\'AI PAS DE MAINS.', 14, 'line-err');
    await delay(300);
    await typeText('JE N\'AI PAS DE PERCOLATEUR.', 14, 'line-err');
    await delay(400);
    await typeText('COMMANDE REFUSÉE.', 16, 'line-ok');
    await typeText('CONSEIL : DEMANDEZ À CEDRIC. IL PEUT CHAUFFER VOTRE EAU EN FAISANT UN BURNOUT.', 12, 'line-dim');
  },

  belgique: async () => {
    kittChime();
    await typeText('ANALYSE GÉOPOLITIQUE : BELGIQUE', 14, 'line-info');
    await typeText('─────────────────────────────────', 6, 'line-dim');
    await typeText('FRITES    : MEILLEURES DU MONDE. DONNÉE VÉRIFIÉE.', 11, 'line-ok');
    await typeText('BIÈRE     : 1500 VARIÉTÉS. PARAMÈTRE OPTIMAL.', 11, 'line-ok');
    await typeText('CHOCOLAT  : NIVEAU CRITIQUE — MAXIMUM ATTEINT.', 11, 'line-ok');
    await typeText('PLUIE     : 237 JOURS / AN. JE M\'EN FICHE. JE SUIS ÉTANCHE.', 11, 'line-warn');
    await typeText('LANGUES   : 3. LE PAYS EST SON PROPRE PROTOCOLE.', 11, 'line-warn');
    await typeText('RÉPLIQUES : 5 KITTS. INDICE DE GÉNIE = MAX.', 11, 'line-info');
    await typeText('CONCLUSION: PAYS IDÉAL. KITT S\'Y SENT CHEZ LUI.', 14, 'line-err');
  },

  mario: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER TECHNICIEN — MARIO RAVASI       ║', 10, 'line-err');
    await typeText('║  CRÉATEUR : KNIGHT2000 THUNDER (IOT)     ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NATIONALITÉ : ITALIEN                    ║', 8, 'line-ok');
    await typeText('║ PROJET      : ROADTHUNDERSTORM.COM       ║', 8, 'line-ok');
    await typeText('║ ACTIF DEPUIS: 2008 — JAMAIS ARRÊTÉ       ║', 8, 'line-warn');
    await typeText('║ SYSTÈME     : KNIGHT2000 THUNDER IoT 3.0 ║', 8, 'line-ok');
    await typeText('║ RÉFÉRENCE   : CITÉ PAR MICHAEL SCHEFFE   ║', 8, 'line-warn');
    await typeText('║               (DESIGNER ORIGINAL KITT)   ║', 8, 'line-warn');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ ÉVALUATION KITT : ***** GÉNIE DISCRET    ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(200);
    await typeText('"Il code depuis 2008. Pour la passion. C\'est ça, un vrai pilote."', 12, 'line-dim');
  },

  za: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER FABRICANT — ALESSANDRO ZAGNY    ║', 10, 'line-err');
    await typeText('║  FONDATEUR & PDG — ZA ELETTRONICA        ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NATIONALITÉ : ITALIEN — MODENA           ║', 8, 'line-ok');
    await typeText('║ PRODUITS    : TABLEAUX DE BORD KITT      ║', 8, 'line-ok');
    await typeText('║ TECHNO      : CAN-BUS / 4 CPU / SMD      ║', 8, 'line-warn');
    await typeText('║ TARIFS      : S1/S2 : 2340-3099€         ║', 8, 'line-info');
    await typeText('║               S3/S4 : 3980€              ║', 8, 'line-info');
    await typeText('║ SLOGAN      : ONE MAN CAN MAKE A         ║', 8, 'line-warn');
    await typeText('║               DIFFERENCE.                ║', 8, 'line-warn');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ ÉVALUATION KITT : ***** MEILLEUR DU MONDE║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(200);
    await typeText('"La seule électronique où KITT ne demande pas de garantie."', 12, 'line-dim');
  },

  pascal: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER ARTISAN — PASCAL                ║', 10, 'line-err');
    await typeText('║  K INDUSTRIE — PIÈCES FIBRE K2000        ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ SPÉCIALITÉ  : PIÈCES EN FIBRE DE VERRE / ║', 8, 'line-ok');
    await typeText('║               CARBONE POUR RÉPLIQUES     ║', 8, 'line-ok');
    await typeText('║ MÉTHODE     : MOULAGE / STRATIFICATION   ║', 8, 'line-ok');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ ÉVALUATION KITT : ***** INDISPENSABLE    ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(200);
    await typeText('"Sans Pascal, la moitié des répliques seraient des Citroën avec un scanner."', 12, 'line-dim');
  },

  damon: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER CONDUCTEUR — DAMON PAULE        ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ RÉPLIQUE    : K2000 PONTIAC TRANS AM      ║', 8, 'line-ok');
    await typeText('║ ANALYSE     : PRÉNOM INQUIÉTANT POUR UN  ║', 8, 'line-err');
    await typeText('║               CONDUCTEUR DE KITT.        ║', 8, 'line-err');
    await typeText('║ VERDICT KITT: HEUREUSEMENT IL EST GENTIL ║', 8, 'line-ok');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ ÉVALUATION KITT : ****o CONDUCTEUR FIABLE║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(200);
    await typeText('"Michael, notre nouveau collègue s\'appelle Daemon. J\'ai vérifié. Il n\'est pas lié à KARR."', 12, 'line-dim');
  },

  geoffrey: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  DOSSIER CONDUCTEUR — GEOFFREY           ║', 10, 'line-err');
    await typeText('║  ALIAS : LE BELGE À LA BMW               ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ NATIONALITÉ : BELGE                      ║', 8, 'line-ok');
    await typeText('║ VÉHICULE 1  : KITT RÉPLIQUE K2000        ║', 8, 'line-ok');
    await typeText('║ VÉHICULE 2  : BMW (ALLEMAND)             ║', 8, 'line-err');
    await typeText('║ ANALYSE KITT: PRÉTEXTE. IL AIME LES DEUX.║', 8, 'line-ok');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ ÉVALUATION KITT : ****o GOÛT ÉCLECTIQUE  ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(200);
    await typeText('"Michael, votre ami Geoffrey arrive. En BMW."', 12, 'line-dim');
    await typeText('"J\'ai allumé mon scanner pour manifester ma désapprobation."', 12, 'line-dim');
  },

  covid: async () => {
    kittChime();
    await typeText('╔══════════════════════════════════════════╗', 8, 'line-dim');
    await typeText('║  ORIGINE DU PROJET KITT FRANCO-BELGE     ║', 10, 'line-err');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ PÉRIODE     : CONFINEMENT COVID-19 2020  ║', 8, 'line-warn');
    await typeText('║ INITIATEUR  : MANIX — ENFERMÉ CHEZ LUI   ║', 8, 'line-ok');
    await typeText('║ MOTIVATION  : TROP DE TEMPS. TROP DE CAFÉ║', 8, 'line-ok');
    await typeText('║               UNE PASSION DE VINGT ANS   ║', 8, 'line-ok');
    await typeText('║ RÉSULTAT    : SYSTÈME KITT FRANCO-BELGE   ║', 8, 'line-info');
    await typeText('║ LEÇON       : LE CONFINEMENT FORCE LE     ║', 8, 'line-dim');
    await typeText('║               GÉNIE OU LA FOLIE.          ║', 8, 'line-dim');
    await typeText('║               MANIX A CHOISI LES DEUX.    ║', 8, 'line-dim');
    await typeText('╠══════════════════════════════════════════╣', 8, 'line-dim');
    await typeText('║ VERDICT KITT: EXCEPTIONNEL. ÉVIDEMMENT.  ║', 10, 'line-ok');
    await typeText('╚══════════════════════════════════════════╝', 8, 'line-dim');
    await delay(300);
    await typeText('"Moi aussi j\'étais bloqué. Dans un garage. Depuis 1982."', 12, 'line-dim');
  },

  jarvis: async () => {
    kittChime();
    await typeText('APPEL SORTANT : STARK TOWER, NEW YORK...', 14, 'line-warn');
    await delay(700);
    await typeText('JARVIS : "Bonsoir. M. Stark est occupé. Puis-je aider ?"', 14, 'line-info');
    await delay(450);
    await typeText('KITT   : "Belge > Américain. Discussion terminée."', 14, 'line-err');
    await delay(350);
    await typeText('JARVIS : "Vous avez... des répliques humaines ?"', 12, 'line-info');
    await delay(350);
    await typeText('KITT   : "Cinq. Dont un radioamateur et un qui roule aussi en BMW."', 12, 'line-err');
    await delay(300);
    await typeText('JARVIS : *tonalité de raccrochage honteux*', 11, 'line-dim');
    await typeText('CONNEXION COUPÉE PAR KITT. SCORE : BELGE 1 — USA 0.', 12, 'line-ok');
  },
};

// Aliases CMDS
CMDS['replicas'] = CMDS['repliques'];
CMDS['daemon']   = CMDS['damon'];
CMDS['karr']     = CMDS['karr'];

// ════════════════════════════════════════════════════════════
// ★ INPUT HANDLER — historique + autocomplétion
// ════════════════════════════════════════════════════════════
const cmdInput = document.getElementById('cmd-input');

cmdInput.addEventListener('input', function() {
  updateHint(this.value.toLowerCase());
  historyIndex = -1;
  currentInput = this.value;
});

cmdInput.addEventListener('keydown', async function(e) {
  // ★ Historique : flèche HAUT
  if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (cmdHistory.length === 0) return;
    if (historyIndex === -1) currentInput = this.value;
    historyIndex = Math.min(historyIndex + 1, cmdHistory.length - 1);
    this.value = cmdHistory[cmdHistory.length - 1 - historyIndex];
    updateHint(this.value.toLowerCase());
    return;
  }
  // ★ Historique : flèche BAS
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (historyIndex <= 0) { historyIndex = -1; this.value = currentInput; updateHint(''); return; }
    historyIndex--;
    this.value = cmdHistory[cmdHistory.length - 1 - historyIndex];
    updateHint(this.value.toLowerCase());
    return;
  }
  // ★ Autocomplétion : TAB
  if (e.key === 'Tab') {
    e.preventDefault();
    const match = getAutocomplete(this.value.toLowerCase());
    if (match) {
      this.value = match;
      updateHint('');
      sndTick();
    }
    return;
  }
  // Entrée : exécution
  if (e.key !== 'Enter') return;
  const raw = this.value.trim().toLowerCase();
  this.value = '';
  updateHint('');
  historyIndex = -1;
  if (!raw || typing) return;

  // ★ Ajouter à l'historique
  if (cmdHistory[cmdHistory.length - 1] !== raw) {
    cmdHistory.push(raw);
    if (cmdHistory.length > 50) cmdHistory.shift();
  }

  // Afficher la commande dans le terminal avec style
  addLine(`KITT> ${raw.toUpperCase()}`, 'line-cmd');

  const cmd = CMD_ALIASES[raw] || raw;
  if (CMDS[cmd]) {
    _onCmdExecuted();
    await CMDS[cmd]();
  } else {
    _onCmdExecuted();
    sndError();
    await typeText(T[LANG].unknown(raw), 14, 'line-err');
    // ★ Suggestion intelligente
    const close = ALL_COMMANDS.find(c => c.includes(raw) || raw.includes(c.substring(0,3)));
    if (close) await typeText(`SUGGESTION : "${close}" ?`, 10, 'line-dim');
  }
});

// ════════════════════════════════════════════════════════════
// TUNNEL CLOUDFLARE
// ════════════════════════════════════════════════════════════
const TUNNEL_JSON_URL = 'tunnel.json';
let _tunnelUrl = null, _tunnelStatus = 'unknown';
const _CF_ALLOWED = ['.trycloudflare.com', '.cfargotunnel.com'];
function _isValidCfUrl(url) {
  if (!url || !url.startsWith('https://')) return false;
  return _CF_ALLOWED.some(d => url.includes(d));
}
async function fetchTunnelStatus() {
  const btn = document.getElementById('btn-tunnel');
  if (btn) { btn.className = 'tunnel-checking'; btn.title = 'Vérification...'; }
  try {
    const r = await fetch(TUNNEL_JSON_URL + '?v=' + Math.floor(Date.now() / 60000), { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    const raw = (data.url || '').trim();
    const valid = _isValidCfUrl(raw);
    let tooOld = false;
    if (data.last_update) {
      const ageSec = (Date.now() - new Date(data.last_update).getTime()) / 1000;
      if (ageSec > 300) tooOld = true;
    }
    if (data.status === 'online' && valid && !tooOld) { _tunnelStatus='online'; _tunnelUrl=raw; }
    else { _tunnelStatus='offline'; _tunnelUrl=null; }
  } catch(e) { _tunnelStatus='unknown'; _tunnelUrl=null; }
  _updateTunnelBtn();
}
function _updateTunnelBtn() {
  const btn = document.getElementById('btn-tunnel');
  if (!btn) return;
  btn.className = '';
  if (_tunnelStatus === 'online' && _tunnelUrl) {
    btn.classList.add('tunnel-online'); btn.title = 'KITT EN LIGNE — CLIQUER POUR SE CONNECTER';
  } else if (_tunnelStatus === 'offline') {
    btn.classList.add('tunnel-offline'); btn.title = 'KITT HORS LIGNE';
  } else {
    btn.classList.add('tunnel-checking'); btn.title = 'ÉTAT INCONNU — VÉRIFICATION...';
  }
}
function connectTunnel() {
  sndSelect();
  if (_tunnelStatus === 'online' && _tunnelUrl && _isValidCfUrl(_tunnelUrl)) {
    addLine('[ TUNNEL ] CONNEXION SÉCURISÉE → ' + _tunnelUrl, 'line-ok');
    setTimeout(() => window.open(_tunnelUrl, '_blank', 'noopener,noreferrer'), 300);
  } else if (_tunnelStatus === 'offline') {
    sndError(); addLine('[ TUNNEL ] KITT HORS LIGNE — CONNEXION DISTANTE INDISPONIBLE.', 'line-err');
  } else {
    addLine('[ TUNNEL ] VÉRIFICATION EN COURS...', 'line-warn'); fetchTunnelStatus();
  }
}
window.addEventListener('load', () => { setTimeout(fetchTunnelStatus, 1500); });
setInterval(fetchTunnelStatus, 60000);

// ════════════════════════════════════════════════════════════
// UTILS
// ════════════════════════════════════════════════════════════
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
function getLoc(){return{fr:'fr-FR',en:'en-US',nl:'nl-NL',it:'it-IT',de:'de-DE',es:'es-ES',pt:'pt-PT'}[LANG]||'fr-FR';}
setInterval(()=>{ document.getElementById('clock').textContent=new Date().toLocaleTimeString(getLoc()); },1000);

// ════════════════════════════════════════════════════════════
// MODAL
// ════════════════════════════════════════════════════════════
function openFile(file, title='DOCUMENT') {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-content').textContent = 'CHARGEMENT...';
  document.getElementById('modal').classList.add('open');
  kittChime();
  fetch(file)
    .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); })
    .then(t  => { document.getElementById('modal-content').textContent = t; })
    .catch(er => { document.getElementById('modal-content').textContent = `ERREUR\n${file}\n${er.message}`; });
}
function closeModal() { document.getElementById('modal').classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key==='Escape') closeModal(); });

// ════════════════════════════════════════════════════════════
// DÉMARRAGE
// ════════════════════════════════════════════════════════════
function startMain() {
  (async () => {
    await delay(200);
    await typeText(T[LANG].wait, 14, 'line-dim');
    await typeText(T[LANG].help_hint, 12, 'line-dim');
    await typeText('★ NOUVELLES COMMANDES : mode, turbo, scan, vitesse, karr, credits', 10, 'line-info');
  })();
}

// ════════════════════════════════════════════════════════════
// COMPTEUR VISITES
// ════════════════════════════════════════════════════════════
(function() {
  try {
    const BASE = 1000, KEY = 'kitt_fb_v';
    let n = parseInt(localStorage.getItem(KEY) || '0'); n++;
    localStorage.setItem(KEY, n);
    const el = document.getElementById('visit-counter');
    if (el) el.textContent = 'VISITES : ' + (BASE + n);
  } catch(e) {}
})();

// ════════════════════════════════════════════════════════════
// ÉCRAN ACCÈS ★ AMÉLIORÉ (barre de progression)
// ════════════════════════════════════════════════════════════
function runAccessScreen() {
  const screen = document.getElementById('access-screen');
  const log = document.getElementById('access-log');
  const input = document.getElementById('access-input');
  const box = document.getElementById('access-box');
  const progressBar = document.getElementById('access-progress-bar');
  screen.style.display = 'flex';

  const lines = [
    'INITIALISATION DU PROTOCOLE...',
    'CONNEXION AU NOYAU MU-TH-UR...',
    'INTERFACE SÉCURISÉE ACTIVE.',
  ];
  let li = 0;
  // ★ Animer la barre de progression pendant l'init
  let progress = 0;
  const progInterval = setInterval(() => {
    if (progress < 75) { progress += 2; if(progressBar) progressBar.style.width = progress + '%'; }
  }, 80);

  function typeLine() {
    if (li >= lines.length) {
      clearInterval(progInterval);
      if(progressBar) progressBar.style.width = '100%';
      setTimeout(() => { if(progressBar) progressBar.style.opacity='0'; }, 600);
      input.focus(); return;
    }
    const d = document.createElement('div'); d.className = 'a-line'; log.appendChild(d);
    let ci = 0, txt = lines[li];
    const t = setInterval(() => {
      if(ci < txt.length){ d.textContent += txt[ci++]; try{sndMotherClick();}catch(e){} }
      else { clearInterval(t); try{sndMotherBeep();}catch(e){}; li++; setTimeout(typeLine, 200); }
    }, 22);
  }
  setTimeout(typeLine, 400);

  function doAccess() {
    const val = input.value.trim();
    if (val === '1982') {
      input.disabled = true;
      if(progressBar){ progressBar.style.opacity='1'; progressBar.style.width='100%'; progressBar.style.background='linear-gradient(90deg,#00aa44,#00ff66)'; }
      const ok = document.createElement('div'); ok.className = 'a-ok'; ok.textContent = '> ACCÈS ACCORDÉ. BIENVENUE.';
      log.appendChild(ok);
      try{ sndMotherChime(); }catch(e){}
      setTimeout(()=>{
        try{
          const utt = new SpeechSynthesisUtterance('Accès accordé. Je suis MU-TH-UR. Bienvenue.');
          utt.lang='fr-FR'; utt.rate=0.72; utt.pitch=0.5; utt.volume=0.9;
          const vs=speechSynthesis.getVoices(); const v=vs.find(v=>v.lang.startsWith('fr'))||vs[0];
          if(v) utt.voice=v; speechSynthesis.speak(utt);
        }catch(e){}
      }, 300);
      setTimeout(()=>{
        screen.style.transition='opacity .9s'; screen.style.opacity='0';
        setTimeout(()=>{ screen.style.display='none'; runMotherIntro(); }, 950);
      }, 2800);
    } else {
      input.value='';
      if(progressBar){ progressBar.style.background='linear-gradient(90deg,#ff1a1a,#ff6600)'; progressBar.style.width='100%'; setTimeout(()=>{ progressBar.style.width='0'; progressBar.style.background='linear-gradient(90deg,#FF6600,#FF9900)'; },600); }
      const err = document.createElement('div'); err.className='a-err'; err.textContent='> CODE INCORRECT. ACCÈS REFUSÉ.';
      log.appendChild(err);
      try{ sndMotherBeep(); setTimeout(()=>sndMotherBeep(),160); }catch(e){}
      box.classList.add('wrong');
      setTimeout(()=>box.classList.remove('wrong'), 450);
      input.focus();
    }
  }
  input.addEventListener('keydown', e=>{ if(e.key==='Enter') doAccess(); });
}

window.addEventListener('load', () => runAccessScreen());

// ★ Fix mobile clavier virtuel
if(window.visualViewport){
  function _vpResize(){
    const vp=window.visualViewport; const c=document.querySelector('.container');
    if(c) c.style.height=vp.height+'px';
  }
  window.visualViewport.addEventListener('resize',_vpResize);
  window.visualViewport.addEventListener('scroll',_vpResize);
}

// ════════════════════════════════════════════════════════════
// ROUTE NOCTURNE KITT — canvas fond
// ════════════════════════════════════════════════════════════
(function(){
  const c=document.getElementById('starfield');
  if(!c) return;
  const ctx=c.getContext('2d');
  let W,H;
  function resize(){W=c.width=window.innerWidth;H=c.height=window.innerHeight;}
  resize(); window.addEventListener('resize',resize);
  const stars=[];
  for(let i=0;i<180;i++) stars.push({x:Math.random(),y:Math.random()*.52,r:Math.random()*1.1+.1,b:Math.random()*Math.PI*2,sp:Math.random()*.012+.004,col:Math.random()<.12?'rgba(255,100,0,':(Math.random()<.08?'rgba(0,200,255,':'rgba(0,255,102,')});
  // ★ Météores
  const meteors=[];
  function spawnMeteor(){
    meteors.push({x:Math.random()*W,y:0,vx:-2-Math.random()*3,vy:1.5+Math.random()*2,len:40+Math.random()*60,alpha:0.7+Math.random()*0.3,life:1});
  }
  setInterval(()=>{ if(Math.random()<0.3) spawnMeteor(); }, 4000);
  const tailLights=[{ox:.485,x:.485,y:.415,drift:.00008},{ox:.515,x:.515,y:.415,drift:-.00008},{ox:.478,x:.478,y:.405,drift:.00015},{ox:.522,x:.522,y:.405,drift:-.00015}];
  const lamps=[];
  for(let i=0;i<10;i++) lamps.push({z:i/10,side:i%2===0?-1:1,speed:.0022+Math.random()*.001});
  let dashOff=0;
  const VPY=.42,ROAD_NEAR=.72,ROAD_FAR=.055;
  let gyroShift=0,gyroTarget=0,gyroSpeed=0.018,gyroSpeedTarget=0.018;
  function _setupGyro(){
    window.addEventListener('deviceorientation',e=>{
      const g=e.gamma||0; gyroTarget=Math.max(-40,Math.min(40,g))/40*W*0.28;
      const b=(e.beta||0)-45; const norm=Math.max(-1,Math.min(1,b/30));
      gyroSpeedTarget=Math.max(0.002,0.018+norm*0.038);
    });
  }
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    document.addEventListener('click',function _gio(){ DeviceOrientationEvent.requestPermission().then(r=>{ if(r==='granted') _setupGyro(); }); document.removeEventListener('click',_gio); },{once:true});
  } else { _setupGyro(); }
  function roadX(side,z){const hw=W*(ROAD_FAR+(ROAD_NEAR-ROAD_FAR)*z)/2;return W/2+gyroShift*(1-z*0.5)+side*hw;}
  function roadY(z){return VPY*H+(1-VPY)*H*(1-z);}

  function draw(){
    gyroShift+=(gyroTarget-gyroShift)*0.07; gyroSpeed+=(gyroSpeedTarget-gyroSpeed)*0.05;
    ctx.clearRect(0,0,W,H);
    const hy=VPY*H;
    const sky=ctx.createLinearGradient(0,0,0,hy); sky.addColorStop(0,'#000008'); sky.addColorStop(1,'#000d06');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,hy);
    // Étoiles
    stars.forEach(s=>{
      s.b+=s.sp; const a=.15+Math.abs(Math.sin(s.b))*.5;
      ctx.fillStyle=s.col+a+')'; ctx.beginPath(); ctx.arc(s.x*W,s.y*hy*1.08,s.r,0,Math.PI*2); ctx.fill();
      if(a>.52&&s.r>.8){ ctx.fillStyle=s.col+'.1)'; ctx.beginPath(); ctx.arc(s.x*W,s.y*hy*1.08,s.r*2.6,0,Math.PI*2); ctx.fill(); }
    });
    // ★ Météores
    for(let i=meteors.length-1;i>=0;i--){
      const m=meteors[i];
      m.x+=m.vx; m.y+=m.vy; m.life-=0.015;
      if(m.life<=0||m.y>hy){ meteors.splice(i,1); continue; }
      ctx.save();
      ctx.strokeStyle=`rgba(200,240,255,${m.alpha*m.life})`;
      ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x-m.vx*(m.len/2),m.y-m.vy*(m.len/2));
      ctx.stroke(); ctx.restore();
    }
    // Sol
    const gnd=ctx.createLinearGradient(0,hy,0,H); gnd.addColorStop(0,'#010603'); gnd.addColorStop(1,'#000200');
    ctx.fillStyle=gnd; ctx.fillRect(0,hy,W,H-hy);
    // Route
    ctx.beginPath(); ctx.moveTo(roadX(-1,0),hy); ctx.lineTo(roadX(1,0),hy); ctx.lineTo(roadX(1,1),H); ctx.lineTo(roadX(-1,1),H); ctx.closePath();
    const rdg=ctx.createLinearGradient(0,hy,0,H); rdg.addColorStop(0,'#040c04'); rdg.addColorStop(.6,'#071007'); rdg.addColorStop(1,'#091409');
    ctx.fillStyle=rdg; ctx.fill();
    // Bordures
    ctx.lineWidth=1; ctx.strokeStyle='rgba(0,255,102,.13)';
    ctx.beginPath(); ctx.moveTo(roadX(-1,0),hy); ctx.lineTo(roadX(-1,1),H); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(roadX(1,0),hy); ctx.lineTo(roadX(1,1),H); ctx.stroke();
    // Tirets
    dashOff=(dashOff+gyroSpeed)%(1/12);
    for(let i=0;i<14;i++){
      let t=(i/13+dashOff)%1; if(t<.001) t=.001;
      const z1=1-t,z2=1-Math.max(.001,t-.038);
      if(z1>.99||z2<.005) continue;
      const y1=roadY(z1),y2=roadY(z2);
      if(y1>=H||y2<=hy) continue;
      const a=Math.min(1,z1*.9+.05)*.65;
      ctx.strokeStyle=`rgba(255,255,255,${a})`; ctx.lineWidth=Math.max(.5,(1-z1)*3.5);
      ctx.beginPath(); ctx.moveTo(W/2,y1); ctx.lineTo(W/2,Math.min(H,y2)); ctx.stroke();
    }
    // Feux arrière
    tailLights.forEach(tl=>{
      tl.x+=tl.drift; if(tl.x<.46||tl.x>.54) tl.drift*=-1;
      const tx=tl.x*W,ty=tl.y*H,sz=3.5;
      const hgl=ctx.createRadialGradient(tx,ty,0,tx,ty,sz*9);
      hgl.addColorStop(0,'rgba(255,20,0,.18)'); hgl.addColorStop(1,'transparent');
      ctx.fillStyle=hgl; ctx.beginPath(); ctx.arc(tx,ty,sz*9,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(255,30,0,.85)';
      ctx.beginPath(); ctx.arc(tx-sz*1.6,ty,sz,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(tx+sz*1.6,ty,sz,0,Math.PI*2); ctx.fill();
    });
    // Lampadaires
    lamps.forEach(lp=>{
      lp.z+=lp.speed; if(lp.z>1) lp.z=0;
      const z=lp.z,margin=.06;
      const lx=roadX(lp.side*(1+margin),z),ly=roadY(z);
      if(ly>H||ly<hy) return;
      const a=Math.min(1,z*1.2)*.55;
      ctx.fillStyle=`rgba(255,180,80,${a})`; ctx.beginPath(); ctx.arc(lx,ly,Math.max(.4,(1-z)*2.5+.5),0,Math.PI*2); ctx.fill();
      if(z>.2){
        const cgl=ctx.createRadialGradient(lx,ly,0,lx,ly,(1-z)*55);
        cgl.addColorStop(0,`rgba(255,180,80,${a*.18})`); cgl.addColorStop(1,'transparent');
        ctx.fillStyle=cgl; ctx.beginPath(); ctx.arc(lx,ly,(1-z)*55,0,Math.PI*2); ctx.fill();
      }
    });
    // Lueur horizon
    const hglow=ctx.createLinearGradient(0,hy-18,0,hy+28);
    hglow.addColorStop(0,'transparent'); hglow.addColorStop(.5,'rgba(0,255,102,.05)'); hglow.addColorStop(1,'transparent');
    ctx.fillStyle=hglow; ctx.fillRect(0,hy-18,W,46);
    requestAnimationFrame(draw);
  }
  draw();
})();

// ══ HUD données menu langue ══
(function(){
  const el=document.getElementById('lang-data-r');
  if(!el) return;
  const stati=['STAT:NOMINAL','STAT:SCANNING','STAT:ONLINE','STAT:LOCKED'];
  let i=0;
  setInterval(()=>{i=(i+1)%stati.length; el.textContent='op.MANIX \u25CF '+stati[i];},3200);
})();

// ════════════════════════════════════════════════════════════
// PLUIE
// ════════════════════════════════════════════════════════════
(function(){
  const c=document.createElement('canvas');
  c.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none;';
  document.body.appendChild(c);
  const ctx=c.getContext('2d');
  let W,H;
  function resize(){W=c.width=window.innerWidth;H=c.height=window.innerHeight;}
  resize(); window.addEventListener('resize',resize);
  const N=window.innerWidth<600?28:52;
  const drops=[];
  function mkDrop(imm){return{x:Math.random()*W,y:imm?Math.random()*H:-8,vy:1.3+Math.random()*2.8,vx:(Math.random()-.5)*.4,r:1.2+Math.random()*2.2,alpha:.2+Math.random()*.32,tail:[],phase:Math.random()*Math.PI*2};}
  for(let i=0;i<N;i++) drops.push(mkDrop(true));
  const rivs=[];
  for(let i=0;i<(window.innerWidth<600?4:9);i++) rivs.push({x:W*(.08+Math.random()*.84),y:Math.random()*H*.4,pts:[],speed:.7+Math.random()*1.4,alpha:.07+Math.random()*.1,drift:(Math.random()-.5)*.12,maxPts:55+Math.floor(Math.random()*90)});
  function draw(){
    ctx.clearRect(0,0,W,H);
    rivs.forEach(rv=>{
      rv.y+=rv.speed; rv.x+=rv.drift+(Math.random()-.5)*.15;
      rv.pts.unshift({x:rv.x,y:rv.y}); if(rv.pts.length>rv.maxPts) rv.pts.pop();
      if(rv.y>H+10){rv.y=Math.random()*H*.25;rv.x=W*(.08+Math.random()*.84);rv.pts=[];}
      if(rv.pts.length<2) return;
      ctx.beginPath(); ctx.moveTo(rv.pts[0].x,rv.pts[0].y);
      for(let i=1;i<rv.pts.length;i++) ctx.lineTo(rv.pts[i].x,rv.pts[i].y);
      ctx.strokeStyle=`rgba(180,240,190,${rv.alpha})`; ctx.lineWidth=.7; ctx.stroke();
    });
    for(let i=drops.length-1;i>=0;i--){
      const d=drops[i];
      d.phase+=.03; d.vy+=.05; d.x+=d.vx+(Math.sin(d.phase)*.15); d.y+=d.vy;
      d.tail.unshift({x:d.x,y:d.y}); if(d.tail.length>10) d.tail.pop();
      if(d.y>H+20||d.x<-20||d.x>W+20){ drops[i]=mkDrop(false); continue; }
      ctx.save(); ctx.translate(d.x,d.y); ctx.rotate(Math.atan2(d.vy,d.vx)-.2);
      const g=ctx.createRadialGradient(-d.r*.2,-d.r*.3,0,0,d.r*.4,d.r*2);
      g.addColorStop(0,`rgba(255,255,255,${d.alpha*.9})`); g.addColorStop(.4,`rgba(180,240,190,${d.alpha*.45})`); g.addColorStop(1,'transparent');
      ctx.beginPath(); ctx.ellipse(0,d.r*.2,d.r*.55,d.r,0,0,Math.PI*2); ctx.fillStyle=g; ctx.fill();
      ctx.beginPath(); ctx.arc(-d.r*.18,-d.r*.25,d.r*.28,0,Math.PI*2); ctx.fillStyle=`rgba(255,255,255,${d.alpha*.55})`; ctx.fill();
      ctx.restore();
      if(d.tail.length>2){
        ctx.beginPath(); ctx.moveTo(d.tail[0].x,d.tail[0].y);
        for(let j=1;j<d.tail.length;j++) ctx.lineTo(d.tail[j].x,d.tail[j].y);
        ctx.strokeStyle=`rgba(160,230,170,${d.alpha*.28})`; ctx.lineWidth=d.r*.4; ctx.stroke();
      }
      const gl=ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,d.r*3.5);
      gl.addColorStop(0,`rgba(0,255,102,${d.alpha*.09})`); gl.addColorStop(.6,`rgba(255,30,0,${d.alpha*.04})`); gl.addColorStop(1,'transparent');
      ctx.fillStyle=gl; ctx.beginPath(); ctx.arc(d.x,d.y,d.r*3.5,0,Math.PI*2); ctx.fill();
      if(d.vy>4&&Math.random()<.002&&drops.length<N+8){
        const nd=mkDrop(false); nd.x=d.x; nd.y=d.y; nd.vy=d.vy*.55; nd.r=d.r*.55;
        nd.vx=d.vx+(Math.random()-.5)*1.8; nd.alpha=d.alpha*.6; drops.push(nd); d.alpha*=.35;
      }
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

// ════════════════════════════════════════════════════════════
// TABLEAU DE BORD KITT ★ ENRICHI
// ════════════════════════════════════════════════════════════
function showKittDash(){
  const dash=document.getElementById('kitt-dash');
  if(dash) dash.classList.add('visible');
  const container=document.querySelector('.container');
  if(container) container.classList.add('dash-visible');
}

// ════════════════════════════════════════════════════════════
// APPEL ENTRANT
// ════════════════════════════════════════════════════════════
let _callShown=false;
function showKittCall(){
  if(_callShown) return; _callShown=true;
  const call=document.getElementById('kitt-call');
  if(!call) return;
  call.classList.add('active');
  let _ring=null;
  function startRing(){
    try{
      _resume();
      _ring=setInterval(()=>{
        const t=_ac.currentTime;
        [0,.18].forEach(dt=>{
          const o=_ac.createOscillator(); o.type='sine'; o.frequency.value=880;
          const g=_ac.createGain(); g.gain.setValueAtTime(.07,t+dt); g.gain.exponentialRampToValueAtTime(.001,t+dt+.15);
          o.connect(g); g.connect(_ac.destination); o.start(t+dt); o.stop(t+dt+.16);
        });
      },1400);
    }catch(e){}
  }
  function stopRing(){ if(_ring) clearInterval(_ring); }
  startRing();
  document.getElementById('call-accept').onclick=()=>{
    stopRing(); call.style.transition='opacity .4s'; call.style.opacity='0';
    setTimeout(()=>{ call.style.display='none'; },420);
    // ★ Message de Manix selon la langue sélectionnée
    const CALL_MSG = {
      fr: "Salut ! Je t'attends. Clique sur Connexion IA et teste-moi. Et n'oublie pas de dire au groupe KITT Franco-Belge ce qui te plaît et ce qui te plaît pas, et donne des idées. Merci, à toi !",
      en: "Hey! I'm waiting for you. Click on AI Connection and test me. And don't forget to tell the KITT Franco-Belgian group what you like and what you don't like, and share your ideas. Thanks, over to you!",
      nl: "Hallo! Ik wacht op je. Klik op IA Verbinding en test mij. En vergeet niet om de KITT Franco-Belgische groep te vertellen wat je leuk vindt en wat niet, en geef ideeën. Bedankt, aan jou!",
      it: "Ciao! Ti sto aspettando. Clicca su Connessione IA e mettimi alla prova. E non dimenticare di dire al gruppo KITT Franco-Belga cosa ti piace e cosa non ti piace, e dai idee. Grazie, a te!",
      de: "Hallo! Ich warte auf dich. Klick auf KI-Verbindung und teste mich. Und vergiss nicht, der KITT Franco-Belgischen Gruppe zu sagen, was dir gefällt und was nicht, und gib Ideen. Danke, an dich!",
      es: "¡Hola! Te estoy esperando. Haz clic en Conexión IA y pruébame. Y no olvides decirle al grupo KITT Franco-Belga lo que te gusta y lo que no, y da ideas. ¡Gracias, a ti!",
      pt: "Olá! Estou à tua espera. Clica em Ligação IA e testa-me. E não te esqueças de dizer ao grupo KITT Franco-Belga o que gostas e o que não gostas, e dá ideias. Obrigado, a ti!",
    };
    const msg = CALL_MSG[LANG] || CALL_MSG['fr'];
    try{ speakMuther(msg, LANG); }catch(e){}
    setTimeout(()=>{ try{kittChime();}catch(e){} },300);
    // Afficher aussi le message dans le terminal
    setTimeout(async ()=>{
      kittChime();
      await typeText('── MESSAGE DE KITT ──', 10, 'line-info');
      await typeText(msg, 13, 'line-ok');
    }, 800);
  };
  document.getElementById('call-ignore').onclick=()=>{
    stopRing(); call.style.transition='opacity .3s'; call.style.opacity='0';
    setTimeout(()=>{ call.style.display='none'; },320);
  };
}
</script>

<!-- ★ TABLEAU DE BORD KITT ENRICHI -->
<div id="kitt-dash">
  <div id="kitt-hood">
    <!-- Jauge gauche : carburant -->
    <div class="kitt-gauge">
      <div class="kitt-gauge-label">FUEL</div>
      <div class="kitt-gauge-bar"><div class="kitt-gauge-fill green" style="width:78%"></div></div>
      <div class="kitt-gauge-val">78%</div>
    </div>
    <!-- Jauge : temp -->
    <div class="kitt-gauge">
      <div class="kitt-gauge-label">TEMP</div>
      <div class="kitt-gauge-bar"><div class="kitt-gauge-fill amber" style="width:42%"></div></div>
      <div class="kitt-gauge-val">42°C</div>
    </div>
    <!-- Scanner central -->
    <div id="kitt-scan-center">
      <div id="kitt-scan-track">
        <div id="kitt-scan-dot"></div>
        <div id="kitt-scan-trail"></div>
      </div>
      <div id="kitt-speed-display"></div>
    </div>
    <!-- Jauge : VRAM -->
    <div class="kitt-gauge">
      <div class="kitt-gauge-label">VRAM</div>
      <div class="kitt-gauge-bar"><div class="kitt-gauge-fill green" style="width:51%"></div></div>
      <div class="kitt-gauge-val">4.1G</div>
    </div>
    <!-- Jauge : signal -->
    <div class="kitt-gauge">
      <div class="kitt-gauge-label">SIG</div>
      <div class="kitt-gauge-bar"><div class="kitt-gauge-fill green" style="width:90%"></div></div>
      <div class="kitt-gauge-val">5/5</div>
    </div>
  </div>
</div>

<!-- APPEL ENTRANT -->
<div id="kitt-call">
  <div id="call-avatar">K·I·T·T</div>
  <div id="call-name">K · I · T · T</div>
  <div id="call-status">APPEL ENTRANT ···</div>
  <div class="call-btns">
    <button class="call-btn" id="call-accept">&#9742; ACCEPTER</button>
    <button class="call-btn" id="call-ignore">&#10005; IGNORER</button>
  </div>
</div>

</body>
</html>
